<babylon-3d>
    <div id="babylon-container">
        <canvas id="render-canvas"></canvas>
    </div>
    <style>
        #babylon-container {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        #render-canvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }

    </style>
    <script>
        const tag = this
        const pixiController = app.getStream('bionetStorageLocation')
        tag.engine = {}
        var scene = {}

        const bionetLabLayout = require('../bionetLabLayout')
        bionetLabLayout.initializeTypes()
        tag.types = bionetLabLayout.types

        const runRenderLoop = function() {
            $('#render-canvas').show()
            tag.engine.runRenderLoop(function() {
                //scene.activeCamera.alpha += .01;
                scene.render();
            });
        }
        const pauseRenderLoop = function() {
            $('#render-canvas').hide()
            tag.engine.stopRenderLoop()
        }

        tag.active = false
        const activate3d = function(activeState) {
            if (activeState) runRenderLoop()
            else pauseRenderLoop()
            tag.active = activeState
            tag.update()
        }
        BIONET.signal.activate3D.add(activate3d)

        const StorageSpec = function(type, materialSpec, dimensions, defaultVisibility) {
            this.type = (type !== undefined) ? type : 'notype'

            const materials = {
                default: {
                    color: new BABYLON.Color3(0, 1, 1),
                    alpha: 0.25
                },
                highlighted: {
                    color: new BABYLON.Color3(1, 0, 0),
                    alpha: 0.25
                },
                selected: {
                    color: new BABYLON.Color3(0, 1, 1),
                    alpha: 0.75
                }
            }

            if (materialSpec !== undefined) {
                if (materialSpec.default !== undefined) materials.default = materialSpec.default
                if (materialSpec.highlighted !== undefined) materials.highlighted = materialSpec.highlighted
                if (materialSpec.selected !== undefined) materials.selected = materialSpec.selected
            }

            this.materials = materials

            const defaultDimensions = {
                width: 1,
                height: 1,
                depth: 1
            }
            this.dimensions = (dimensions !== undefined) ? dimensions : defaultDimensions
            this.scalingFactor = 3

            this.defaultVisibility = (defaultVisibility !== undefined) ? defaultVisibility : true
        }

        StorageSpec.prototype.createMaterial = function(scene, name, color, alpha) {
            const material = new BABYLON.StandardMaterial(name, scene);
            material.alpha = alpha;
            material.diffuseColor = color;
            material.ambientColor = color;
            material.specularColor = new BABYLON.Color3(1.0, 1.0, 1.0);
            return material
        }

        StorageSpec.prototype.initMaterials = function(scene) {
            const materials = this.materials
            materials.default.m = this.createMaterial(scene, this.type + 'DefaultMaterial', materials.default.color, materials.default.alpha)
            materials.highlighted.m = this.createMaterial(scene, this.type + 'HighlightedMaterial', materials.highlighted.color, materials.highlighted.alpha)
            materials.selected.m = this.createMaterial(scene, this.type + 'SelectedMaterial', materials.selected.color, materials.selected.alpha)
            this.materials = materials
        }

        StorageSpec.prototype.createElement = function(scene, name, x, y, z, visible) {
            const width = this.dimensions.width
            const height = this.dimensions.height
            const depth = this.dimensions.depth

            var element = BABYLON.MeshBuilder.CreateBox(name, {
                height: height,
                width: width,
                depth: depth,
            }, scene);
            element.position.x = x
            element.position.y = y
            element.position.z = z
            element.visibility = (visible !== undefined) ? visible : true
            element.material = this.materials.default.m;
        }

        StorageSpec.prototype.defaultMaterial = function(scene, name) {
            const element = scene.getMeshByName(name);
            if (element === undefined || element === null) return
            element.material = this.materials.default.m;
            element.visibility = this.defaultVisibility
        }

        StorageSpec.prototype.highlight = function(scene, name) {
            const element = scene.getMeshByName(name);
            if (element === undefined || element === null) return
            element.material = this.materials.highlighted.m;
            element.visibility = true
        }

        StorageSpec.prototype.select = function(scene, name) {
            const element = scene.getMeshByName(name);
            if (element === undefined || element === null) return
            element.material = this.materials.selected.m;
            element.visibility = true
        }
        const scalingFactor = 3

        const boxSpec = new StorageSpec('box', {
            highlighted: {
                color: new BABYLON.Color3(1, 0, 0),
                alpha: 1
            }
        }, {
            width: (scalingFactor / 4) - 0.3,
            height: 0.7 / 4,
            depth: 1.8 / 5
        }, false)

        const rackSpec = new StorageSpec('rack', {
            highlighted: {
                color: new BABYLON.Color3(1, 0, 0),
                alpha: 0.5
            }
        }, {
            width: (scalingFactor) / 4 - 0.2,
            height: 0.8,
            depth: 2
        })

        const shelfSpec = new StorageSpec('shelf', {
            default: {
                color: new BABYLON.Color3(0, 1, 1),
                alpha: 1
            },
            highlighted: {
                color: new BABYLON.Color3(1, 1, 0),
                alpha: 1
            }
        }, {
            width: scalingFactor,
            height: 0.1,
            depth: 2.1
        })

        this.on('mount', function() {

            const canvas = document.getElementById('render-canvas');
            tag.engine = new BABYLON.Engine(canvas, true);
            const engine = tag.engine
            var lab = {}
            var highlightPathObj = []

            const moveCameraToElement = function(name) {
                const targetObj = scene.getMeshByName(name);
                if (!targetObj) return
                var x = targetObj.position.x
                var y = Math.max(targetObj.position.y - 1, 4)
                    //var z = Math.max(targetObj.position.z + 2, -1)
                var z = targetObj.position.z + 1
                y = Math.min(y, 2)
                moveCamera(null, x, y, z)
            }

            const setupLocationPath = function(locationPath) {
                var id = ''
                unhighlightPath()
                highlightPathObj = []
                for (var i = locationPath.length - 1; i >= 0; i--) {
                    const locationSpec = locationPath[i]
                    var x = Number(locationSpec.parent_x)
                    var y = Number(locationSpec.parent_y)
                    var type = locationSpec.type
                    if (type === undefined) continue
                    var stype = ''
                    if (type.indexOf('box') >= 0) {
                        stype = 'box'
                        id += ".box" + x + "," + y
                    } else if (type.indexOf('rack') >= 0) {
                        stype = 'rack'
                        x = x - 1
                        id += ".rack" + x
                    } else if (type.indexOf('shelf') >= 0) {
                        stype = 'shelf'
                        id += ".shelf" + y
                    } else if (type.indexOf('freezer') >= 0 || type.indexOf('fridge') >= 0) {
                        stype = 'freezer'
                        id += locationSpec.name
                    }
                    highlightElementType(id, stype)
                    highlightPathObj.push({
                        name: id,
                        type: stype
                    })
                }
                console.log('setupLocationPath id:', id)
                moveCameraToElement(id)
                if (BIONET.state.toggle3d) runRenderLoop()
                else pauseRenderLoop()
                return


                if (BIONET.state.toggle3d) runRenderLoop()
                else pauseRenderLoop()

            }

            const typeSpecs = {
                box: boxSpec,
                rack: rackSpec,
                shelf: shelfSpec
            }

            const highlightElementType = function(id, type) {
                const typeSpec = typeSpecs[type]
                if (typeSpec === undefined) return
                typeSpec.highlight(scene, id)
            }

            const unhighlightPath = function() {
                for (var i = 0; i < highlightPathObj.length; i++) {
                    var element = highlightPathObj[i]
                    const typeSpec = typeSpecs[element.type]
                    if (typeSpec === undefined) continue
                    typeSpec.defaultMaterial(scene, element.name)
                }
            }

            const freezerWidth = 3

            const createBox = function(id, xp, yp, zp, highlight, xindex, yindex) {
                const x = xp + ((freezerWidth / 4) - 0.2) / 2 + 0.1
                const y = yp + 0.8 / 2 + 0.1
                const z = zp + boxSpec.dimensions.depth / 2
                boxSpec.createElement(scene, id, x, y, z, false)
                const boxObj = {
                    name: id,
                    children: [],
                    x: xindex,
                    y: yindex,
                    alpha: 1,
                    type: '8 x 12 freezer box'
                }
                return boxObj
            }

            const createRack = function(id, xp, yp, zp, index) {

                const width = rackSpec.dimensions.width
                const height = rackSpec.dimensions.height
                const depth = rackSpec.dimensions.depth
                const x = xp + rackSpec.dimensions.width / 2 + 0.1
                const y = yp + height / 2
                const z = zp + -0.05
                rackSpec.createElement(scene, id, x, y, z)

                const bx = xp - 0.1
                const zd = z + depth / -2
                const rack = {
                    name: id,
                    type: 'freezer rack',
                    x: index + 1,
                    color: {},
                    children: []
                }

                for (var row = 0; row < 4; row++) {
                    var by = yp + (row * height / 4) - (height / 2)
                    for (var col = 0; col < 5; col++) {
                        const xindex = 5 - col
                        const yindex = 4 - row
                        var boxId = id + ".box" + xindex + "," + yindex
                        var bz = zd + col * depth / 5
                        var highlight = (Math.random() > 0.99) ? true : false
                        var boxObj = createBox(boxId, bx, by, bz, false, xindex, yindex)
                        rack.children.push(boxObj)
                    }
                }
                return rack
            }

            const createShelf = function(id, xp, yp, zp, index) {

                const width = shelfSpec.dimensions.width
                const height = shelfSpec.dimensions.height
                const depth = shelfSpec.dimensions.depth
                const x = xp
                const y = yp + height / 2
                const z = zp
                shelfSpec.createElement(scene, id, x, y, z)

                const shelf = {
                    name: id,
                    type: 'shelf',
                    x: index,
                    color: {},
                    alpha: 1,
                    children: []
                }
                for (var rack = 0; rack < 4; rack++) {
                    var rackId = id + ".rack" + rack
                    var rackObj = createRack(rackId, xp + (rack * freezerWidth / 4) - freezerWidth / 2, yp + height, z, rack)
                    shelf.children.push(rackObj)
                }
                return shelf
            }

            const createFreezer = function(id, x, y, z, index) {

                const freezer = {
                    name: id,
                    type: '-80 freezer',
                    x: index,
                    children: []
                }
                for (var shelf = 0; shelf < 5; shelf++) {
                    sid = 5 - shelf
                    var shelfId = id + ".shelf" + sid
                    var shelfObj = createShelf(shelfId, x, shelf + y, z, sid)
                    freezer.children.push(shelfObj)
                }
                return freezer
            }

            const createScene = function(inventoryModel) {
                // create a basic BJS Scene object
                scene = new BABYLON.Scene(engine);

                // create a FreeCamera, and set its position
                var camera = new BABYLON.ArcRotateCamera("ArcRotateCamera", 0, 0 * Math.PI, 0 * Math.PI, new BABYLON.Vector3(0, 5, -8), scene);

                // target the camera to scene origin
                camera.setTarget(new BABYLON.Vector3(0, 2, 0));

                // attach the camera to the canvas
                camera.attachControl(canvas, false);

                // create a basic light, aiming 0,1,0 - meaning, to the sky
                var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0, 1, 0), scene);

                const y = 0
                const labObj = inventoryModel[0]
                lab = {
                    name: labObj.dbData.name,
                    type: 'lab',
                    children: []
                }

                boxSpec.initMaterials(scene)
                rackSpec.initMaterials(scene)
                shelfSpec.initMaterials(scene)

                const appSettings = BIONET.getAppSettings()
                const labLayout = appSettings.labLayout

                // find all physical freezer objects in inventoryModel
                for (var freezer = 0; freezer < labObj.children.length; freezer++) {
                    const freezerData = labObj.children[freezer].dbData
                    var freezerId = freezerData.name

                    const freezerLayout = labLayout[freezerData.parent_x]
                    if (freezerLayout===undefined) continue
                    const x = (40-freezerLayout.y / 15)
                    const z = (80-freezerLayout.x / 15)
                        //var freezerObj = createFreezer(freezerId, freezer * (freezerWidth + 0.5) - (1.5 * (freezerWidth + 0.5)), y, z, freezer)
                    var freezerObj = createFreezer(freezerId, x, y, z, freezer)
                    lab.children.push(freezerObj)
                }

                // create a built-in "ground" shape; its constructor takes 5 params: name, width, height, subdivisions and scene
                var ground = BABYLON.Mesh.CreateGround('ground1', 80, 80, 2, scene);
                var materialGround = new BABYLON.StandardMaterial("groundTexture", scene);
                materialGround.alpha = 1;
                materialGround.diffuseColor = new BABYLON.Color3(0.75, 0.75, 0.75);
                materialGround.ambientColor = new BABYLON.Color3(0.75, 0.75, 0.75);
                materialGround.specularColor = new BABYLON.Color3(1.0, 1.0, 1.0);
                ground.material = materialGround;

                var VJC = new BABYLON.VirtualJoysticksCamera("VJC", BABYLON.Vector3.Zero(), scene);
                scene.clearColor = new BABYLON.Color4(0, 0, 0, 0);
                return scene;
            }

            const moveCamera = function(callback, dx, dy, dz) {
                console.log('move camera ', dx, dy)
                var translatex = new BABYLON.Animation("camTranslatex", "target.x", 60, BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
                var keysx = [{
                    frame: 0,
                    value: scene.activeCamera.target.x
                }, {
                    frame: 100,
                    value: dx
                }];
                translatex.setKeys(keysx);
                scene.activeCamera.animations.push(translatex);

                var translatey = new BABYLON.Animation("camTranslatey", "target.y", 60, BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
                var keysy = [{
                    frame: 0,
                    value: scene.activeCamera.target.y
                }, {
                    frame: 100,
                    value: dy
                }];
                translatey.setKeys(keysy);
                scene.activeCamera.animations.push(translatey);

                var translatez = new BABYLON.Animation("camTranslatez", "target.z", 60, BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
                var keysz = [{
                    frame: 0,
                    value: scene.activeCamera.target.z
                }, {
                    frame: 100,
                    value: dz
                }];
                translatez.setKeys(keysz);
                scene.activeCamera.animations.push(translatez);

                scene.beginAnimation(scene.activeCamera, 0, 100, false, 5.0, callback);
            }

            function onPixiEvent(cmd, msgdata) {
                if (cmd === undefined) return;
                const pixiMsgHandler = {
                    selectCell: function(msg) {
                        // find item in the location path that was clicked
                        const locationPath = tag.locationPath
                        const id = msg.id
                        for (var i = 0; i < locationPath.length; i++) {
                            const locationSpec = locationPath[i]
                            if (locationSpec.id === id) {
                                const cell = msg.cell
                                locationSpec.parent_x = cell.x
                                locationSpec.parent_y = cell.y
                                unhighlightPath()
                                setupLocationPath(locationPath)
                                break
                            }

                        }
                    },
                    configure: function(msg) {
                        //todo: this may be invoked before resources have loaded
                        const id = msg
                        console.log('babylon-3d tag configure function, id=', id)
                        app.remote.getLocationPath(id, function(err, locationPath) {
                            if (err) {
                                console.log('getLocationPath error:', err)
                                return
                            }
                            console.log('babylon-3d getLocationPath result:', JSON.stringify(locationPath))

                            const container = locationPath[0]
                            const parent = locationPath[1]
                            tag.container = container
                            tag.locationPath = locationPath

                            // add lab storage to stage and render
                            const config = {
                                locationPath: locationPath,
                                title: container.name
                            }
                            const meshName = ''
                            unhighlightPath()
                            setupLocationPath(locationPath)
                        })
                    },
                    setupModel: function(msg) {
                        scene = createScene(msg);
                    }
                }
                if (pixiMsgHandler[cmd] !== undefined) pixiMsgHandler[cmd](msgdata);
            }
            var eventBinding = pixiController.add(onPixiEvent);

            window.addEventListener('resize', function() {
                engine.resize();
            });
        })

    </script>
</babylon-3d>
