<babylon-3d>
    <div id="babylon-container">
        <canvas id="render-canvas"></canvas>
    </div>
    <style>
        #babylon-container {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        #render-canvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }

    </style>
    <script>
        const tag = this
        const pixiController = app.getStream('bionetStorageLocation')
        tag.engine = {}
        var scene = {}

        const bionetLabLayout = require('../bionetLabLayout')
        bionetLabLayout.initializeTypes()
        tag.types = bionetLabLayout.types

        const runRenderLoop = function() {
            $('#render-canvas').show()
            tag.engine.runRenderLoop(function() {
                //scene.activeCamera.alpha += .01;
                scene.render();
            });
        }
        const pauseRenderLoop = function() {
            $('#render-canvas').hide()
            tag.engine.stopRenderLoop()
        }

        tag.active = false
        const activate3d = function(activeState) {
            if (activeState) runRenderLoop()
            else pauseRenderLoop()
            tag.active = activeState
            tag.update()
        }
        BIONET.signal.activate3D.add(activate3d)

        this.on('mount', function() {

            const canvas = document.getElementById('render-canvas');
            tag.engine = new BABYLON.Engine(canvas, true);
            const engine = tag.engine
            var lab = {}
            var highlightPathObj = []

            const moveCameraToElement = function(name) {
                const targetObj = scene.getMeshByName(name);
                if (!targetObj) return
                var x = targetObj.position.x
                var y = Math.max(targetObj.position.y - 1, 1)
                y = Math.min(y, 2)
                moveCamera(null, x, y)
            }

            const setupLocationPath = function(locationPath) {
                var id = ''
                unhighlightPath()
                highlightPathObj = []
                for (var i = locationPath.length - 1; i >= 0; i--) {
                    const locationSpec = locationPath[i]
                    var x = Number(locationSpec.parent_x)
                    var y = Number(locationSpec.parent_y)
                    var hcolor = new BABYLON.Color3(1, 0, 0)
                    var halpha = 0.5
                    var ucolor = new BABYLON.Color3(0, 1, 1)
                    var ualpha = 0.25
                    var type = locationSpec.type
                    if (type.indexOf('box') >= 0) {
                        halpha = 1.0
                        id += ".box" + x + "," + y
                    } else if (type.indexOf('rack') >= 0) {
                        hcolor = new BABYLON.Color3(0, 1, 1)
                        x = x - 1
                        id += ".rack" + x
                    } else if (type.indexOf('shelf') >= 0) {
                        halpha = 1.0
                        ualpha = 1.0
                        hcolor = new BABYLON.Color3(1, 1, 0)
                        ucolor = new BABYLON.Color3(0, 0.75, 0.75)
                        id += ".shelf" + y
                    } else if (type.indexOf('freezer') >= 0) {
                        id += locationSpec.name
                    }
                    highlightElement(id, true, hcolor, halpha)
                    highlightPathObj.push({
                        name: id,
                        color: ucolor,
                        alpha: ualpha
                    })
                }
                console.log('setupLocationPath id:', id)
                moveCameraToElement(id)
                if (BIONET.state.toggle3d) runRenderLoop()
                else pauseRenderLoop()
                return


                if (BIONET.state.toggle3d) runRenderLoop()
                else pauseRenderLoop()

            }

            const highlightElement = function(name, highlight, color, origAlpha) {
                const obj = scene.getMeshByName(name);
                if (obj === null || obj === undefined) return
                console.log('highlighting object: %s %s %s %s', obj.name, highlight, color, origAlpha)
                var highlightColor = (color !== undefined) ? color : new BABYLON.Color3(0, 1, 1)
                var alpha = 0.25
                if (origAlpha === undefined || origAlpha === null) {
                    alpha = (highlight === true) ? 0.5 : 0.25
                } else {
                    alpha = origAlpha
                }
                console.log('highlighting object, alpha=', alpha)

                var visible = true
                if (highlight === true) {
                    highlightColor = (color !== undefined) ? color : new BABYLON.Color3(1, 0, 0)
                } else {
                    if (name.indexOf('box') >= 0) visible = false
                }
                var highlightMaterial = new BABYLON.StandardMaterial("highlightTexture", scene);
                highlightMaterial.alpha = alpha;
                highlightMaterial.diffuseColor = highlightColor;
                highlightMaterial.ambientColor = highlightColor;
                highlightMaterial.specularColor = new BABYLON.Color3(1.0, 1.0, 1.0);
                obj.material = highlightMaterial;

                obj.visibility = visible
            }

            const unhighlightPath = function() {
                for (var i = 0; i < highlightPathObj.length; i++) {
                    var element = highlightPathObj[i]
                    highlightElement(element.name, false, element.color, element.alpha)
                }
            }

            const createElement = function(props) {
                const name = props.name
                const width = props.width
                const height = props.height
                const depth = props.depth
                const x = props.x
                const y = props.y
                const z = props.z
                const boxColor = (props.color) ? props.color : new BABYLON.Color3(0, 0.25, 1)
                const alpha = (props.alpha) ? props.alpha : 1

                var box = BABYLON.MeshBuilder.CreateBox(name, {
                    height: height,
                    width: width,
                    depth: depth,
                }, scene);
                box.position.x = x
                box.position.y = y
                box.position.z = z
                if (props.visible !== undefined) box.visibility = props.visible

                var materialBox1 = new BABYLON.StandardMaterial("texture1", scene);
                materialBox1.alpha = alpha;
                materialBox1.diffuseColor = boxColor;
                materialBox1.ambientColor = boxColor;
                materialBox1.specularColor = new BABYLON.Color3(1.0, 1.0, 1.0);
                box.material = materialBox1;

            }
            const freezerWidth = 3

            const createBox = function(id, x, y, z, highlight, xindex, yindex) {
                const width = (freezerWidth / 4) - 0.3
                const height = 0.7 / 4
                const depth = 1.8 / 5
                const color = (highlight === true) ? new BABYLON.Color3(1, 0, 0) : new BABYLON.Color3(0, 1, 1)
                const alpha = (highlight === true) ? 1 : 0.25
                const elementProps = {
                    name: id,
                    width: width,
                    height: height,
                    depth: depth,
                    x: x + ((freezerWidth / 4) - 0.2) / 2 + 0.1,
                    y: y + 0.8 / 2 + 0.1,
                    z: z + depth / 2,
                    color: color,
                    alpha: 1,
                    visible: false
                }
                createElement(elementProps)
                const boxObj = {
                    name: id,
                    children: [],
                    x: xindex,
                    y: yindex,
                    alpha: 1,
                    type: '8 x 12 freezer box'
                }
                return boxObj
            }

            const createRack = function(id, x, y, index) {
                const width = (freezerWidth) / 4 - 0.2
                const height = 0.8
                const depth = 2
                const z = -0.05
                const color = new BABYLON.Color3(0, 1, 1)
                const elementProps = {
                    name: id,
                    width: width,
                    height: height,
                    depth: depth,
                    x: x + width / 2 + 0.1,
                    y: y + height / 2,
                    z: z,
                    color: color,
                    alpha: 0.25
                }
                createElement(elementProps)
                const bx = x - 0.1
                const zd = z + depth / -2
                const rack = {
                    name: id,
                    type: 'freezer rack',
                    x: index + 1,
                    color: color,
                    children: []
                }
                for (var row = 0; row < 4; row++) {
                    var by = y + (row * height / 4) - (height / 2)
                    for (var col = 0; col < 5; col++) {
                        const xindex = 5 - col
                        const yindex = 4 - row
                        var boxId = id + ".box" + xindex + "," + yindex
                        var bz = zd + col * depth / 5
                        var highlight = (Math.random() > 0.99) ? true : false
                            //if (highlight === true) {
                        var boxObj = createBox(boxId, bx, by, bz, false, xindex, yindex)
                        rack.children.push(boxObj)
                            //}
                    }
                }
                return rack
            }

            const createShelf = function(id, x, y, index) {
                const width = freezerWidth
                const height = 0.1
                const depth = 2.1
                const color = new BABYLON.Color3(0, 0.75, 0.75)
                const elementProps = {
                    name: id,
                    width: width,
                    height: height,
                    depth: depth,
                    x: x,
                    y: y + height / 2,
                    z: 0,
                    color: color,
                    alpha:1.0
                }
                createElement(elementProps)
                const shelf = {
                    name: id,
                    type: 'shelf',
                    x: index,
                    color: color,
                    alpha: 1,
                    children: []
                }
                for (var rack = 0; rack < 4; rack++) {
                    var rackId = id + ".rack" + rack
                    var rackObj = createRack(rackId, x + (rack * freezerWidth / 4) - freezerWidth / 2, y + height, rack)
                    shelf.children.push(rackObj)
                }
                return shelf
            }

            const createFreezer = function(id, x, y, index) {

                const freezer = {
                    name: id,
                    type: '-80 freezer',
                    x: index,
                    children: []
                }
                for (var shelf = 0; shelf < 5; shelf++) {
                    sid = 5 - shelf
                    var shelfId = id + ".shelf" + sid
                    var shelfObj = createShelf(shelfId, x, shelf + y, sid)
                    freezer.children.push(shelfObj)
                }
                return freezer
            }

            const createScene = function(inventoryModel) {
                // create a basic BJS Scene object
                scene = new BABYLON.Scene(engine);

                // create a FreeCamera, and set its position
                //var camera = new BABYLON.FreeCamera('camera1', new BABYLON.Vector3(0, 4, -9), scene);
                var camera = new BABYLON.ArcRotateCamera("ArcRotateCamera", 0, 0, 0, new BABYLON.Vector3(0, 4, -9), scene);

                // target the camera to scene origin
                camera.setTarget(new BABYLON.Vector3(0, 2, 0));

                // attach the camera to the canvas
                camera.attachControl(canvas, false);

                // create a basic light, aiming 0,1,0 - meaning, to the sky
                var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0, 1, 0), scene);

                const y = 0
                const labObj = inventoryModel[0]
                lab = {
                        name: labObj.dbData.name,
                        type: 'lab',
                        children: []
                    }
                
                // find all physical freezer objects in inventoryModel
                for (var freezer = 0; freezer < labObj.children.length; freezer++) {
                    const freezerData = labObj.children[freezer].dbData
                    var freezerId = freezerData.name
                    var freezerObj = createFreezer(freezerId, freezer * (freezerWidth + 0.5) - (1.5 * (freezerWidth + 0.5)), y, freezer)
                    lab.children.push(freezerObj)
                }

                // create a built-in "ground" shape; its constructor takes 5 params: name, width, height, subdivisions and scene
                var ground = BABYLON.Mesh.CreateGround('ground1', 4.5 * 4 + 2, 6, 2, scene);
                var materialGround = new BABYLON.StandardMaterial("groundTexture", scene);
                materialGround.alpha = 1;
                materialGround.diffuseColor = new BABYLON.Color3(0.75, 0.75, 0.75);
                materialGround.ambientColor = new BABYLON.Color3(0.75, 0.75, 0.75);
                materialGround.specularColor = new BABYLON.Color3(1.0, 1.0, 1.0);
                ground.material = materialGround;

                var VJC = new BABYLON.VirtualJoysticksCamera("VJC", BABYLON.Vector3.Zero(), scene);
                scene.clearColor = new BABYLON.Color4(0, 0, 0, 0);
                return scene;
            }

            const moveCamera = function(callback, dx, dy) {
                console.log('move camera ', dx, dy)
                var translatex = new BABYLON.Animation("camTranslatex", "target.x", 60, BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
                var keysx = [{
                    frame: 0,
                    value: scene.activeCamera.target.x
                }, {
                    frame: 100,
                    value: dx
                }];
                translatex.setKeys(keysx);
                scene.activeCamera.animations.push(translatex);

                var translatey = new BABYLON.Animation("camTranslatey", "target.y", 60, BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
                var keysy = [{
                    frame: 0,
                    value: scene.activeCamera.target.y
                }, {
                    frame: 100,
                    value: dy
                }];
                translatey.setKeys(keysy);
                scene.activeCamera.animations.push(translatey);

                var translatez = new BABYLON.Animation("camTranslatez", "target.z", 60, BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
                var keysz = [{
                    frame: 0,
                    value: scene.activeCamera.target.z
                }, {
                    frame: 100,
                    value: 1.5
                }];
                translatez.setKeys(keysz);
                scene.activeCamera.animations.push(translatez);
                scene.beginAnimation(scene.activeCamera, 0, 100, false, 5.0, callback);
            }

            function onPixiEvent(cmd, msgdata) {
                if (cmd === undefined) return;
                const pixiMsgHandler = {
                    selectCell: function(msg) {
                        // find item in the location path that was clicked
                        const locationPath = tag.locationPath
                        const id = msg.id
                        for (var i = 0; i < locationPath.length; i++) {
                            const locationSpec = locationPath[i]
                            if (locationSpec.id === id) {
                                const cell = msg.cell
                                locationSpec.parent_x = cell.x
                                locationSpec.parent_y = cell.y
                                unhighlightPath()
                                setupLocationPath(locationPath)
                                break
                            }

                        }
                    },
                    configure: function(msg) {
                        //todo: this may be invoked before resources have loaded
                        const id = msg
                        console.log('babylon-3d tag configure function, id=', id)
                        app.remote.getLocationPath(id, function(err, locationPath) {
                            if (err) {
                                console.log('getLocationPath error:', err)
                                return
                            }
                            console.log('babylon-3d getLocationPath result:', JSON.stringify(locationPath))

                            const container = locationPath[0]
                            const parent = locationPath[1]
                            tag.container = container
                            tag.locationPath = locationPath

                            // add lab storage to stage and render
                            const config = {
                                locationPath: locationPath,
                                title: container.name
                            }
                            const meshName = ''
                            unhighlightPath()
                            setupLocationPath(locationPath)
                        })
                    },
                    setupModel: function(msg) {
                        scene = createScene(msg);
                    }
                }
                if (pixiMsgHandler[cmd] !== undefined) pixiMsgHandler[cmd](msgdata);
            }
            var eventBinding = pixiController.add(onPixiEvent);

            window.addEventListener('resize', function() {
                engine.resize();
            });
        })

    </script>
</babylon-3d>
