<create-physical>

  <div class="container" style="margin-top:100px">
    <h5 id="createPhysicalHeader"></h5>
    <form name="createPhysicalForm" class="col s12" onsubmit={submitForm}>
      <form-text-input label="Name" name="name" value={formData.name}/>
      <form-textarea-input label="Notes" name="notes" value={formData.notes}/>
      <p>
        Barcode: <span id="curBarcode"></span><a id="scanButton" class="waves-effect waves-light btn" onclick={scanItem}>scan</a> or <a id="createLabelButton" class="waves-effect waves-light btn" onclick={createLabel}>create label</a>
      </p>
      <div style="display:block;float:left">Location: <span id="curContainerBarcode"></span><a id="containerScanButton" class="waves-effect waves-light btn" onclick={scanContainer} style="margin-right:10px">scan container</a> or </div>
      <div id="autocomplete-container" class="col s12" style="width:300px;padding-left:15px;float:left">

      </div>
      <std-button label="submit" action={submitForm} />
      <input type="submit" style="visibility:hidden" />
    </form>

    <div id="scanModal" class="scanModal modal"></div>
    <div id="printModal" class="printModal modal"></div>
  </div>
  <script>
    /*

       * ensure date/time and author are always saved
    
       * make create-physical capable of editing
       * make /p/id and /p/humanID routes work
       * get /scan working
       ** and link it from top menu

       * test printing
       * link create-physical from create-form
       * link create (virtual) from create-form


       * get normal search working
       * make create-form talk to database
       * get inventory search working
       * get create-physical autocomplete working


       # To Bring

       * raspi/bbb + sd card for printer
       ** all cables for this
       * raspberry pi + touchscreen combo
       ** cable for raspi to touchscreen connection
       ** power adapter and long microusb cable
       * flatbed scanner
       * tablets and eyepieces


       # Thursday + Friday

       * ensure access control works

       * add Tim's physicals list to materials
       * request part feature
       * global search feature
       * get multi-tube scanner working

    */

    function savePhysical(p, labelImage, cb) {
      var doPrint = labelImage ? true : false
      app.remote.savePhysical(p, labelImage, doPrint, function(err, id) {
        if(err) {
          return cb(err);
        }
        if(!p.id) {
          p.created = new Date();
        }
        p.updated = new Date();
        
        cb(null, id);
      })
    }

    /*
       TODO:
         associate with virtual
         save full inventory path 
    */
    this.submitForm = function(e) {
      e.preventDefault()
      var formData = $.formToObject(self.createPhysicalForm) || {};
      formData.label = self.labelFormData
      savePhysical(formData, self.labelImageData, function(err, id) {
        if(err) {
          app.ui.toast("Error: " + err); // TODO improve
          return;
        }
        app.ui.toast("Saved to database")
      });
    }

    this.createLabel = function() {

      var labelOpts = {
        title: self.printNameDefault,
        bsl: 1
      }

      var opts = {
        title: "Create label",
        subtitle: undefined,
        subTag: "print", // the tag to mount
        label: self.labelFormData || labelOpts,
        cb: function(err, formData, imageData) {
          self.labelFormData = formData;
          self.labelImageData = imageData;
          $(self.printModal).closeModal();
          $(self.createLabelButton).html('edit label');
        }
      }
      var tags = riot.mount('#printModal', 'modal-content', opts)

      $(self.printModal).openModal({
        complete: function() { 
          tags[0].unmount(true)
        }
      })
    }

    this.scanItem = function() {
      var opts = {
        title: "Scan",
        subtitle: "Scan the item's barcode",
        subTag: "scan", // the tag to mount
        cb: function(err, id) {
          if(err) return app.ui.toast("Scan failed: " + err); // TODO handle error
          $(self.curBarcode).html('  ' + id + '  ');
          $(self.scanButton).html('rescan');
          $(self.scanModal).closeModal();
          tags[0].unmount(true)
        }
      }
      var tags = riot.mount('#scanModal', 'modal-content', opts)

      $(self.scanModal).openModal({
        complete: function() { 
          tags[0].unmount(true)
        }
      })
    }

    this.scanContainer = function() {
      var opts = {
        title: "Scan location",
        subtitle: "Scan the barcode of e.g. the box or freezer where you put this item",
        subTag: "scan",
        cb: function(err, id) {
          if(err) return app.ui.toast("Scan failed: " + err); // TODO handle error
          $(self.curContainerBarcode).html('  ' + id + '  ');
          $(self.containerScanButton).html('rescan container');

          $(self.scanModal).closeModal();
          tags[0].unmount(true)
        }
      }
      var tags = riot.mount('#scanModal', 'modal-content', opts)

      $(self.scanModal).openModal({
        complete: function() { 
          tags[0].unmount(true)
        }
      })
    }

    this.on('mount', function() {

      if(!self.formData) {
        self.formData = {};
      }
      if(this.opts.query && this.opts.query.name && this.opts.query.name.trim()) {
        self.formData.name = decodeURIComponent(this.opts.query.name);;
      }

      this.update();

      riot.mount('#autocomplete-container', 'autocomplete', {
        searchCallback: function(query, cb) {
          app.remote.physicalAutocomplete(query, cb);
        }
      });

      if(opts.virtualID) {
        // create new physical instance of this material
        app.remote.getMaterial(this.opts.virtualID, function(err, virtual) {
          if(err) {
            app.ui.toast(err); // TODO handle better
            return;
          }
          self.printNameDefault = $(self.createPhysicalForm.name).val().trim() || virtual.name
          $(self.createPhysicalHeader).html("New " + virtual.name)

          // TODO

        }.bind(this));
        return;
      }

      console.log("Creating:", this.opts.type);
      app.remote.getType(this.opts.type, function(err, type) {
        if(err) {
          if(err.notFound) {
            // we are creating a material of unknown type
            riot.route('/create-unknown/' + encodeURIComponent(this.opts.type))
            return
          }
          return app.ui.toast(err); // TODO handle better
        }
        // We are creating a new material of type: opts.type

        if(type.virtual) { 
          // this type needs to be a virtual that then has physicals associated
          riot.route('/create/' + encodeURIComponent(this.opts.type));
          return;
        }

        self.printNameDefault = $(self.createPhysicalForm.name).val().trim() || type.name
        $(self.createPhysicalHeader).html("New " + type.name)

        // TODO

      }.bind(this));
    }.bind(this));

  </script>
</create-physical>


<modal-content>
  <div>
    <div class="modal-content">
      <h4>{opts.title}</h4>
      <p>{opts.subtitle}</p>
      <div id="modalContents"></div>
    </div>
<!--
    <div class="modal-footer">
      <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">Agree</a>
    </div>
-->
  </div>

  <script>

    var tags;

    this.on('mount', function() {
      tags = riot.mount('#modalContents', this.opts.subTag, this.opts);
    })

    this.on('before-unmount', function() {
      tags[0].unmount()
    })

  </script>
</modal-content>
