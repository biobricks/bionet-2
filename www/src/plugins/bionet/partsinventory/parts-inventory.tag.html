
<parts-inventory>
    <div id="inventory-wrapper">
        <!--
        <div class="row flex-row" style="margin-bottom:0; padding-bottom:0">
            <div class="col s1 m1 l1 flex-col" style="padding:0">
            </div>
            <div style="width:8.3333333333%"></div>
                <div style="width:55px"></div>
            <div style="col s7 m7 l7 flex-col">
                <h5>{selectedName}</h5>
            </div>
            <div style="col s4 m4 l4 flex-col">
            </div>
        </div>
                -->
        <div style="margin-left:8.3333333333%; padding-left:10px; margin-bottom:0">
            <h5>{selectedName}</h5>
        </div>
        <div class="row flex-row" style="margin-bottom:0; padding-bottom:0">
            <div id="action-icons" class="flex-col col s1 m1 l1" style="padding:0">
            </div>
            <div id="navview" class="flex-col col s7 m7 l7">
                <div class="flex-row" style="margin-bottom:10px;">
                    <div class="flex-item-right" style="display:flex">
                        <!--
                                <div id="navigate" class="horizontal-nav-button" data-constrainwidth="false" onclick={setSelectionMode}><i id="navigate_icon" class="material-icons horizontal-nav-button-contents">forward</i></div>
                        <div id="edit" class="horizontal-nav-button " data-constrainwidth="false" onclick={setSelectionMode}><i id="edit_icon" class="material-icons horizontal-nav-button-contents">edit</i></div>

                                <div class="horizontal-nav-button " data-constrainwidth="false" onclick={addToFavorites}><i class="material-icons">star</i></div>

                                <div id="deleteicon" class="horizontal-nav-button " onclick={deleteItem}><i class="material-icons">delete</i>
                                </div>

                        <div id="move" class="horizontal-nav-button " data-constrainwidth="false" onclick={setSelectionMode}><i id="move_icon" class="material-icons horizontal-nav-button-contents">shuffle</i></div>


                        <div id="threedicon" onclick={activate3d} class="horizontal-nav-button"><span class="horizontal-nav-button-contents">3D</span></div>
                                -->
                    </div>
                </div>
                <div class="flex-row" style="margin-bottom:10px;min-width:340px">
                    <!--
                    <div id="path_vis" class="flex-item"></div>
                    -->
                    <div id="lab_vis" class="flex-item"></div>
                    <div id="freezer_vis" class="flex-item"></div>
                    <div id="shelf_vis" class="flex-item"></div>
                    <div id="rack_vis" class="flex-item"></div>
                    <div id="box_vis" class="flex-item"></div>
                    <div id="part_vis" class="flex-item"></div>
                </div>
                <div id="nav-zoom" class="flex-row">
                    <!--
                            <div id="zoomItemTable" class="flex-item"></div>
                            -->
                    <div id="itemDataGrid" class="flex-item"></div>
                </div>
                <div if={!enableNavZoom} class="flex-row">
                    <!--
                            <div id="threedview" class="row threedview" style="margin:0;padding:0;">
                                <babylon-3d></babylon-3d>
                            </div>
                            -->
                    <div id="physical-props-view" class="row physical-view">
                        <div id="physical-storage" class="edit-physical" style="width:100%">
                            <create-physical show="true" top-margin="0px" style="width:100%" />
                        </div>
                        <!--
                                <div id="box" class="edit-physical" style="width:100%">
                                    <box-contents />
                                </div>
                                -->
                        <div id="material-form" class="row physical-view">
                        </div>
                    </div>
                </div>
            </div>

            <div id="favview" class="flex-row col s4 m4 l4" style="margin-top:10px">
                <div class="flex-row" style="margin-bottom:10px;flex-wrap: wrap; align-items: flex-start; justify-content: flex-start;">
                    <div id="zoomItem_vis" class="flex-item"></div>
                    <div id="zoomItemImage_vis" class="flex-item"></div>
                    <div id="edititem" class="flex-item"></div>
                    <div id="favorites_vis" class="flex-item"></div>
                </div>
            </div>
        </div>

        <div id="addicon" class="btn-floating btn-large waves-effect waves-light blue dropdown-button" data-constrainwidth="false" data-hover="true" style="position:fixed; top:120px; {iconXPos}; width:55px; height:55px;" data-activates="addmenu"><i class="material-icons">add</i></div>

        <ul id="addmenu" class="dropdown-content" style="position:fixed; top:110px; {iconXPos}; width:200px !important; text-align:left;z-index:1000">
            <!--
            <li each={item in locations} class="add-type"><span onclick={addItem}>{item.title}</span></li>
            -->
            <li if={createType==='storage' } each={item in locations} class="add-type"><span onclick={addItem}>{item.title}</span></li>
            <li if={createType==='material' } each={item in materials} class="add-type"><span onclick={addMaterial}>{item.title}</span></li>
        </ul>

        <a class="btn-floating btn-large waves-effect waves-light blue dropdown-button" data-constrainwidth="false" style="position:fixed; top:190px; {iconXPos}; text-align:left" onclick={addToFavorites}><i class="material-icons">star</i></a>

        <div id="edit" style="position:fixed; top:260px; {iconXPos}; width:55px; height:55px;" class="btn-floating btn-large waves-effect waves-light blue" data-constrainwidth="false" onclick={setSelectionMode}><i id="edit_icon" class="material-icons horizontal-nav-button-contents">edit</i></div>

        <div id="deleteicon" style="position:fixed; top:330px; {iconXPos}; width:55px; height:55px;" onclick={deleteItem} class="btn-floating btn-large waves-effect waves-light blue"><i class="material-icons">delete</i></div>

        <form id="importForm">
            <div class="file-field input-field">
                <div id="uploadicon" style="position:fixed; top:400px; {iconXPos}; width:55px; height:55px;" onclick={upload} class="btn-floating btn-large waves-effect waves-light blue"><i class="material-icons">open_in_browser</i>
                    <input id="upload-file" type="file">
                </div>
            </div>
        </form>

        <delete-modal deleteaction={deleteAction}></delete-modal>
        <modal-physical title={modalPhysicalTitle} modalaction={modalAction} modaldata={modalData}/>
        <div id="edit-virtual-modal" class="modal">
            <modal-virtual if={modalVirtualOpen} title={modalVirtualTitle} modalaction={modalAction} modaldata={modalData} query={modalQuery} open={modalVirtualOpen}/>
        </div>

    </div>

    <style>
        #nav-subheader {
            margin: 0;
            padding: 0;
            width: 100%;
            background-color: #f5f5f5;
        }
        /*
            background-image: url(/static/images/appbarBorder.png);
            background-repeat: repeat-x;
        */
        
        #nav-subheader-bottom {
            height: 10px;
            width: 100%;
        }
        
        .flex-row {
            display: -webkit-flex;
            display: flex;
            -webkit-flex-direction: row;
            flex-direction: row;
            margin: 0;
            padding: 0;
        }
        
        .flex-col {
            display: -webkit-flex;
            display: flex;
            -webkit-flex-direction: column;
            flex-direction: col;
        }
        
        .flex-item {
            margin-right: 20px;
            //margin-bottom: 20px;
        }
        
        .flex-item-right {
            margin-left: auto;
        }
        
        .horizontal-nav-button {
            margin-right: 15px;
        }
        
        .horizontal-nav-button-contents {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            color: #ffffff;
            background-color: #2196F3;
        }
        
        .selected-table-row td {
            border: 1px solid black;
            background: #00ffff!important;
        }
        
        .threedview {
            overflow-y: auto;
            overflow-x: hidden;
            margin-top: 0px;
            padding-top: 0px;
            margin-bottom: 0px;
            padding-bottom: 0px;
            width: 100%;
            height: 70%;
            float: left;
        }
        
        .physical-view {
            overflow-y: auto;
            overflow-x: hidden;
            margin-top: 0px;
            margin-bottom: 0px;
            padding-top: 0px;
            padding-bottom: 40px;
            width: 100%;
            height: 70%;
            float: left;
        }
        
        #physical-view {
            position: fixed;
            margin-top: 0px;
        }
        
        #physical-props-view {
            z-index: 1;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        
        .edit-physical {
            width: 100%;
            float: left;
            display: block;
        }
        
        ul.tabs .tab.active {
            text-transform: lowercase !important;
            color: #4285f4 !important;
            border-bottom: 3px solid #4285f4;
            padding-right: 10px;
            padding-left: 10px;
        }
        
        .active-button {
            color: #00ffff !important;
        }
        
        ul.tabs .tab {
            text-transform: lowercase !important;
            color: #4285f4 !important;
            padding-right: 10px;
            padding-left: 10px;
        }
        
        .vg-tooltip {
            font-size: 14px;
        }

    </style>
    <script>
        const tag = this

        const appSettings = BIONET.getAppSettings()
        const dataTypes = appSettings.dataTypes
        const async = require('async')

        tag.materials = []
        tag.locations = []
        for (var i = 0; i < dataTypes.length; i++) {
            const type = dataTypes[i]
            if (type.virtual === true) {
                type.url = '/create-virtual/' + encodeURI(type.name)
                tag.materials.push(type)
            } else {
                type.url = '/create-physical/' + encodeURI(type.name)
                tag.locations.push(type)
            }
        }
        tag.createType = 'storage'
        tag.modalQuery = null

        this.on('mount', function() {
            const windowWidth = $(window).innerWidth()
            const windowHeight = $(window).innerHeight()

            const updateLayout = function() {
                const layout = {
                    leftWidth: $('#action-icons').width(),
                    centerWidth: $('#navview').width(),
                    rightWidth: $('#favview').width(),
                    topMargin: $('#appbar').height(),
                    bottomMargin: $('.bionet-page-footer').height(),
                    windowWidth: windowWidth,
                    windowHeight: windowHeight
                }
                layout.centerWidth = windowWidth - (layout.leftWidth + layout.rightWidth)
                layout.centerHeight = windowHeight - (layout.topMargin + layout.bottomMargin)
                tag.layout = layout
                BIONET.signal.setLayout.dispatch(tag.layout)
            }
            updateLayout()

            $('#navview').css({
                width: tag.layout.centerWidth
            })

            $('#inventory-wrapper').css({
                marginTop: $('#appbar').height(),
                height: $(window).innerHeight() - $('#appbar').height() - $('.bionet-page-footer').height(),
            });

            $('#lab_vis').hide()
            $('#zoomItem_vis').hide()

            tag.iconXPos = 'left:' + ($('#action-icons').width() - 55) * 0.5 + 'px'

            tag.selectionMode = BIONET.NAV_SELECTION
                //$('#edit_icon').addClass('active-button')

            tag.enableNavZoom = true
            tag.selectedName = ''
                //var selectionMode = BIONET.NAV_SELECTION

            var q = (this.opts.q) ? decodeURIComponent(this.opts.q) : null;

            BIONET_DATAGRID.setContainer('itemDataGrid')

            $('.dropdown-button').dropdown({
                inDuration: 300,
                outDuration: 225,
                constrainWidth: false,
                hover: true,
                gutter: 0,
                belowOrigin: true,
                alignment: 'left',
                stopPropagation: false
            });

            $('.modal').modal();

            const generateRows = function(n) {
                const rows = []
                for (var i = 0; i < n; i++) {
                    var row = {
                        id: i,
                        partname: 'part' + i,
                        creator: 'created' + i,
                        updated: 'upd' + i,
                        location: Number(i).toString() + ',' + Number(n - i).toString(),
                        cart: true
                    }
                    rows.push(row)
                }
                return rows
            }

            tag.randomTest = function() {
                const dataset1 = generateRows(41)
                BIONET_DATAGRID.updateDataTable(dataset1)
                    //BIONET_VIS.signal.test.dispatch('random')
            }

            tag.pathTest = function() {
                //BIONET_VIS.signal.navigateInventoryItem.dispatch('p-a4b81480-e449-4563-9fd6-8194cd21c348')
            }
            tag.setMode = function(e) {

            }

            var uploadFileElement = document.getElementById('upload-file');
            uploadFileElement.addEventListener('change', function(e) {
                const parent_id = BIONET_VIS.getSelectedItemId()
                const fileName = uploadFileElement.value
                if (this.files && this.files.length > 0) {
                    async.eachSeries(this.files, function(file, next) {
                        tag.readFile(file, next, parent_id)
                    })
                }
            })

            tag.readFile = function(file, next, parent_id) {

                if (file.type.match(/csv/i)) {
                    var reader = new FileReader();
                    reader.onload = function(e2) { // finished reading file data.
                        //BIONET.signal.generatePhysicalsFromUpload.dispatch(e2.target.result, parent_id)
                        BIONET.signal.generatePhysicalsFromTwistUpload.dispatch(e2.target.result, parent_id)
                        next();
                    }
                    reader.readAsText(file); // start reading the file data.

                    // match genbank extension
                } else if (file.name.match(/\.gbk?$|\.genbank$/i)) {

                    var reader = new FileReader();
                    reader.onload = function(e2) { // finished reading file data.
                        BIONET.signal.generatePhysicalFromGenbankUpload.dispatch(file.name, e2.target.result, parent_id)
                        next();
                    }
                    reader.readAsText(file); // start reading the file data.        
                }
            }

            tag.addToFavorites = function() {
                const currentItem = BIONET_VIS.getSelectedItem()
                if (currentItem) {
                    BIONET.signal.addFavorite.dispatch(currentItem.dbData)
                }
            }

            const getChildren = function(id, cb) {
                BIONET.remote.getChildren(id, function(err, children) {
                    if (err) return console.error(err);
                    const ichildren = []
                    for (var i = 0; i < children.length; i++) {
                        var child = children[i]
                        if (id === child.value.parent_id) ichildren.push(child)
                    }
                    cb(id, ichildren)
                })
            }

            const retrieveLocationPath = function(id, cb) {
                if (!id) return
                const locationPath = {}
                var results = 0
                BIONET.remote.getLocationPath(id, function(err, locationPathAr) {
                    if (err) {
                        console.log('getLocationPath error:', err)
                        return
                    }
                    results = locationPathAr.length
                    for (var i = 0; i < locationPathAr.length; i++) {
                        var location = locationPathAr[i]
                        var locationId = location.id
                        locationPath[locationId] = location
                        getChildren(locationId, (pid, children) => {
                            locationPath[pid].children = children
                            if (--results <= 0) cb(locationPath)
                        })
                    }
                })
            }

            const getChildTable = function(children) {
                const table = []
                for (var i = 0; i < children.length; i++) {
                    var child = children[i].value
                    if (!child) continue
                    var location = null
                    if (child.parent_x) {
                        location = child.parent_x + ',' + child.parent_y
                    }
                    var d = new Date()
                    d.setTime(child.updated.time * 1000)
                    var row = {
                        id: i,
                        physicalId: child.id,
                        partname: child.name,
                        creator: child.created.user,
                        updated: d.toDateString(),
                        location: location,
                        parent_x: child.parent_x,
                        parent_y: child.parent_y,
                        cart: true
                    }
                    table.push(row)
                }
                return table
            }
            const refreshInventoryPath = function(id) {
                console.log('refreshInventoryPath:', id)
                retrieveLocationPath(id, (path) => {
                    BIONET_VIS.signal.setLocationPath.dispatch(id, path)
                    const selectedChildren = getChildTable(path[id].children)
                    if (id.indexOf('p->') >= 0 || id.indexOf('v-') >= 0) {
                        tag.editPart(path[id])
                        $('#edititem').show()
                    } else {
                        BIONET_DATAGRID.updateDataTable(selectedChildren)
                        $('#edititem').hide()
                    }
                })
            }
            BIONET.signal.refreshInventoryPath.add(refreshInventoryPath)

            const selectInventoryItem = function(id, selectionModeVis) {
                BIONET.signal.setLayout.dispatch(tag.layout)
                const selectionMode = selectionModeVis || BIONET_VIS.getSelectionMode()
                if (selectionMode === BIONET.EDIT_SELECTION) {
                    //editSelection = BIONET_VIS.getEditSelection()
                    editSelection = BIONET_VIS.getEditSelection()
                    if (editSelection && editSelection.dbData) {
                        //if (editSelection.physicalId) {
                        if (editSelection.dbData.type === 'physical') {
                            tag.editMaterial()
                        } else {
                            tag.editItem()
                                //BIONET.signal.getPhysical.dispatch(id)
                        }
                        //} else {
                        // create new physical and add to parent
                        //console.log('selectInventoryItem: create new physical', JSON.stringify(editSelection), id)
                        //}
                    }
                    return
                } else if (selectionMode === BIONET.MOVE_SELECTION) {
                    BIONET.signal.highlightItem.dispatch(BIONET_VIS.ZOOM_ITEM, id)
                    BIONET_VIS.setMoveItemId(id)
                    const currentItem = BIONET_VIS.getSelectedItem()
                    console.log('selectInventoryItem: move', id, currentItem)
                        /*
                        const parentId = currentItem.parent_id
                        retrieveLocationPath(parentId, (path) => {
                            BIONET_VIS.signal.setLocationPath.dispatch(parentId, path)
                        })
                        */
                    return
                }

                retrieveLocationPath(id, (path) => {
                        //console.log('retrieveLocationPath:', JSON.stringify(path, null, 2))
                    BIONET_VIS.signal.setLocationPath.dispatch(id, path)
                    const type = BIONET_VIS.getSelectedType()
                    const currentItem = BIONET_VIS.getSelectedItem()
                    console.log('retrieveLocationPath:', path, type, currentItem)
                    if (currentItem) {
                        tag.selectedName = currentItem.name
                    }
                    tag.createType = (type === 'box') ? 'material' : 'storage'
                    const selectedChildren = getChildTable(path[id].children)
                    updateLayout()
                    if (type==='part' || id.indexOf('v-') >= 0) {
                        $('#edititem').show()
                        tag.editPart(currentItem.dbData)
                    } else {
                        $('#edititem').hide()
                        BIONET_DATAGRID.updateDataTable(selectedChildren)
                    }
                    tag.update()
                })
            }
            BIONET.signal.updateInventoryPath.add(selectInventoryItem)

            tag.addItem = function(e) {

                var parentId = BIONET_VIS.getSelectedItemId()
                    // initialize storage type
                const active = $(e.target)
                const title = active.text()
                var type = null
                for (var i = 0; i < tag.locations.length; i++) {
                    if (tag.locations[i].title === title) {
                        type = tag.locations[i].name
                    }
                }
                if (!type) {
                    console.log('addNode, type not found for title:', title)
                    return
                }

                // generate unique name
                const name = title

                // initialize standard attributes
                const dbData = {
                    name: '',
                    type: type,
                    parent_id: parentId
                }

                // initialize attributes
                const attributes = app.getAttributesForType(type)
                for (var i = 0; i < attributes.length; i++) {
                    dbData[attributes[i].name] = type + ' ' + attributes[i].name
                }

                tag.modalPhysicalTitle = "Create " + title
                tag.modalData = dbData
                tag.displayPhysical = false
                tag.modalOpen = true
                var physicalUpdatedDetach
                const physicalUpdatedModal = function(modalData) {
                    if (tag.modalOpen) {
                        console.log('close edit physical modal')
                        $('#edit-physical-modal').modal('close');
                        tag.displayPhysical = true
                        tag.modalOpen = false
                        tag.update()
                        selectInventoryItem(parentId, BIONET.NAV_SELECTION)
                        physicalUpdatedBinding.detach()
                    }
                }
                physicalUpdatedBinding = BIONET.signal.physicalUpdated.add(physicalUpdatedModal)
                tag.update()

                $('#edit-physical-modal').modal('open');
                BIONET.signal.getPhysicalResult.dispatch(dbData)

            }

            tag.editItem = function(e) {

                var parentId = BIONET_VIS.getSelectedItemId()
                    // initialize storage type
                var editSelection = BIONET_VIS.getEditSelection()
                if (!editSelection || !editSelection.dbData) return
                const dbData = editSelection.dbData

                tag.modalPhysicalTitle = "Edit " + dbData.name
                tag.modalData = dbData
                tag.displayPhysical = false
                tag.modalOpen = true
                var physicalUpdatedDetach
                const physicalUpdatedModal = function(modalData) {
                    if (tag.modalOpen) {
                        console.log('close edit physical modal')
                        $('#edit-physical-modal').modal('close');
                        tag.displayPhysical = true
                        tag.modalOpen = false
                        tag.update()
                        selectInventoryItem(parentId, BIONET.NAV_SELECTION)
                        physicalUpdatedBinding.detach()
                    }
                }
                physicalUpdatedBinding = BIONET.signal.physicalUpdated.add(physicalUpdatedModal)
                tag.update()

                $('#edit-physical-modal').modal('open');
                BIONET.signal.getPhysicalResult.dispatch(dbData)

            }

            tag.addMaterial = function(e) {

                var parentId = BIONET_VIS.getSelectedItemId()
                    // initialize storage type
                const active = $(e.target)
                const title = active.text()
                var type = null
                for (var i = 0; i < tag.materials.length; i++) {
                    if (tag.materials[i].title === title) {
                        type = tag.materials[i].name
                    }
                }
                if (!type) {
                    console.log('addMaterial, type not found for title:', title)
                    return
                }

                // generate unique name
                const name = title

                // initialize standard attributes
                const dbData = {
                    name: '',
                    type: type,
                    parent_id: parentId
                }

                // initialize attributes
                const attributes = app.getAttributesForType(type)
                for (var i = 0; i < attributes.length; i++) {
                    dbData[attributes[i].name] = type + ' ' + attributes[i].name
                }

                tag.modalVirtualTitle = "Create " + title
                tag.modalData = dbData
                tag.modalType = type
                    //tag.displayPhysical = false
                tag.modalVirtualOpen = true
                var virtualSaveResultBinding
                const virtualUpdatedModal = function(modalData) {
                    if (tag.modalVirtualOpen) {
                        console.log('close edit virtual modal')
                        $('#edit-virtual-modal').modal('close');
                        tag.modalVirtualOpen = false
                        tag.update()
                        virtualSaveResultBinding.detach()
                    }
                }
                virtualSaveResultBinding = BIONET.signal.virtualSaveResult.add(virtualUpdatedModal)
                tag.update()
            }

            tag.editMaterial = function(e) {

                // initialize storage type
                //var editSelection = BIONET_VIS.getSelectedItem()
                var editSelection = BIONET_VIS.getEditSelection()
                if (!editSelection || !editSelection.dbData) {
                    console.log('editMaterial: null selection')
                    return
                }

                const dbData = editSelection.dbData
                tag.modalData = dbData
                tag.modalType = dbData.type
                tag.modalQuery = {
                    name: dbData.name
                }
                tag.modalVirtualTitle = "Edit " + dbData.name
                tag.modalVirtualOpen = true
                var virtualSaveResultBinding
                const virtualUpdatedModal = function(modalData) {
                    if (tag.modalVirtualOpen) {
                        console.log('close edit virtual modal')
                        $('#edit-virtual-modal').modal('close');
                        tag.modalVirtualOpen = false
                        tag.modalQuery = null
                        tag.modalData = null
                        tag.modalType = null
                        tag.update()
                        virtualSaveResultBinding.detach()
                    }
                }
                virtualSaveResultBinding = BIONET.signal.virtualSaveResult.add(virtualUpdatedModal)
                tag.update()
                $('#edit-virtual-modal').modal('open');
            }

            tag.deleteItem = function() {
                tag.deleteAction = function() {
                    const deleteNodes = []

                    const delChildren = function(item) {
                        if (!item.children) return
                        getChildren(item.id, (pid, children) => {
                            for (var i = 0; i < item.children.length; i++) {
                                const childNode = item.children[i]
                                delChildren(childNode)
                                deleteNodes.push(childNode)
                            }
                        })
                    }

                    const currentItem = BIONET_VIS.getSelectedItem()
                    if (currentItem && currentItem.dbData) {
                        const dbData = currentItem.dbData
                        const parentId = dbData.parent_id
                        delChildren(dbData)
                        deleteNodes.push(dbData)

                        const physicalDeleted = function() {
                            selectInventoryItem(parentId)
                        }
                        BIONET.signal.physicalDeleted.add(physicalDeleted)

                        for (var i = 0; i < deleteNodes.length; i++) {
                            const item = deleteNodes[i]
                            var id = null
                            if (item.favorite_id) id = item.favorite_id
                            else id = item.id
                            BIONET.signal.delPhysical.dispatch(id)
                        }
                    }

                }
                $('#deleteModal').modal('open');
            }

            tag.editPart = function(item) {
                console.log('editPart:', item)

                if (item.id.indexOf('p-') >= 0) {
                    riot.mount('#edititem', 'create-physical', {
                        topMargin: 0
                    })

                    BIONET.signal.getPhysical.dispatch(item.id)

                    const bionetStorageLocation = app.getStream('bionetStorageLocation')
                    bionetStorageLocation.dispatch('configure', item.id)

                    tag.itemType = 'p'
                } else if (item.id.indexOf('v-') >= 0) {
                    riot.mount('#edititem', 'part-specification')

                    // TODO: messaging async api call
                    partDataAccessor.route('getVirtual', undefined, item.id)
                    tag.itemType = 'v'
                    p
                } else {
                    tag.itemType = ''
                }
                console.log('itemClick, type:%s %s', tag.itemType, JSON.stringify(item))
                tag.update()

                app.setBreadcrumbs([{
                    'label': 'search',
                    'url': '/search'
                }, {
                    'label': opts.terms,
                    'url': '/search/' + opts.terms,
                }, {
                    'label': item.primary_text,
                    'url': '/search/' + opts.terms
                }])
            }

            tag.setSelectionMode = function(e) {
                const active = $(e.target)
                const buttonId = e.currentTarget.id
                var selectionMode = null
                const prevNavZoom = tag.enableNavZoom
                switch (buttonId) {
                    case 'navigate':
                        selectionMode = BIONET.NAV_SELECTION
                        $('#navigate_icon').addClass('active-button')
                        $('#move_icon').removeClass('active-button')
                        $('#edit_icon').removeClass('active-button')
                            //$('#zoomItem_vis').hide()
                        tag.enableNavZoom = true
                        tag.modalVirtualOpen = false
                        break;
                    case 'move':
                        selectionMode = BIONET.MOVE_SELECTION
                        $('#move_icon').addClass('active-button')
                        $('#edit_icon').removeClass('active-button')
                        $('#navigate_icon').removeClass('active-button')
                            //$('#zoomItem_vis').show()
                        tag.enableNavZoom = true
                        tag.modalVirtualOpen = false
                        break;
                    case 'edit':
                        if (tag.selectionMode === BIONET.EDIT_SELECTION) {
                            $('#edit_icon').removeClass('active-button')
                            selectionMode = BIONET.NAV_SELECTION
                        } else {
                            $('#edit_icon').addClass('active-button')
                            selectionMode = BIONET.EDIT_SELECTION
                        }
                        tag.selectionMode = selectionMode
                        break;
                }
                tag.update()

                console.log('setSelectionMode:', selectionMode)
                if (selectionMode) {
                    const navSelection = (selectionMode === BIONET.EDIT_SELECTION) ? BIONET.MOVE_SELECTION : BIONET.NAV_SELECTION
                    BIONET.signal.setSelectionMode.dispatch(BIONET_VIS.ZOOM_ITEM_TABLE, selectionMode)
                    BIONET.signal.setSelectionMode.dispatch(BIONET_VIS.ZOOM_ITEM_IMAGE, navSelection)
                    BIONET.signal.setSelectionMode.dispatch(BIONET_VIS.ZOOM_ITEM, navSelection)
                }
            }

            tag.upload = function() {
                BIONET.signal.generatePhysicalsFromTwistUpload.dispatch()
            }

            const enableLocationPathSections = function(sectionId) {
                for (prop in sectionId) {
                    if (sectionId.hasOwnProperty(prop)) {
                        var enable = sectionId[prop]
                        var id = '#' + prop + '_vis'
                        if (enable) {
                            $(id).show()
                        } else {
                            $(id).hide()
                        }
                    }
                }
            }

            tag.update()

            const getFavoritesResult = function(favorites) {
                const favoritesArr = []
                for (var i = 0; i < favorites.length; i++) {
                    var favorite = favorites[i].favorite
                    var material = favorites[i].material
                    material.material_id = favorite.material_id
                    material.favorite_id = favorite.id
                    favoritesArr.push(material)
                }
                BIONET_VIS.signal.setFavorites.dispatch(favoritesArr)
            }


            tag.rootId = null
            BIONET_VIS.init(() => {
                const selectInventoryItemBinding = BIONET.signal.selectInventoryItem.add(selectInventoryItem)
                const enableLocationPathSectionsBinding = BIONET_VIS.signal.enableLocationPathSections.add(enableLocationPathSections)
                const getFavoritesResultBinding = BIONET.signal.getFavoritesResult.add(getFavoritesResult)

                // request favorites
                BIONET.signal.getFavorites.dispatch()

                // retrieve inventory root node
                // todo: skip if id parameter provided
                if (q) {
                    selectInventoryItem(q)
                    return
                }
                BIONET.remote.inventoryTree(function(err, children) {
                    for (var i = 0; i < children.length; i++) {
                        var item = children[i].value
                        if (!item.parent_id && item.type === 'lab') {
                            tag.rootId = item.id
                            tag.rootItem = item
                            selectInventoryItem(tag.rootId)
                            break;
                        }
                    }
                })
            })
        })

    </script>
</parts-inventory>
/* */
<parts-inventory-form>
    <div style="padding-top:100px;" />
    <form onsubmit={submitForm}>
        <!--
        <search-input label="search inventory" ref="searchinventory" name="searchinventory" action={submitForm}/>
        <input type="submit" style="display:none" />
        -->
        <div if={nodes.length>0} class="{theme.style.color.background +' '+ theme.style.color.text}">
            <!--
            <list-header primary-header={primaryHeader} secondary-header={secondaryHeader}/>
            -->
            <inventory-treeview nodes={nodes} />
        </div>
    </form>
    <script>
        const tag = this
        this.theme = app.getTheme();
        this.nodes = [];
        //var q = (this.opts.q) ? decodeURIComponent(this.opts.q) : undefined;
        var q = ''
        const updateInventoryTree = function() {
            console.log('parts-inventory-form: updateInventoryTree q=', q)
            if (q === undefined) return;
            const matchAll = (q.length > 0) ? false : true;
            //tag.refs.searchinventory.value = q;

            //q = new RegExp(q.replace(/\s+/, '.*'), 'i');


            function itemFromNode(node) {

            }

            app.remote.inventoryTree(function(err, children) {
                if (err) return console.error(err);

                // TODO rewrite this matching algorithm 
                //      so we can do single-pass matching
                //      so we can use a stream
                //      And move it to the level-tree-index module

                var matches = [];
                this.nodes = [];

                var i, cur, indent, a;
                for (i = 0; i < children.length; i++) {
                    cur = children[i].path;
                    if (cur.match(q) || matchAll) matches.push(cur);
                }

                var j, m, add, perfect;
                for (i = 0; i < children.length; i++) {
                    cur = children[i].path;
                    a = cur.split('.');
                    indent = a.length - 1;
                    add = false
                    perfect = false
                    for (j = 0; j < matches.length; j++) {
                        m = matches[j];
                        if (m.indexOf(cur) === 0) {
                            add = true;
                            if (m.length === cur.length) perfect = true;
                            break;
                        }
                    }
                    if (add) {
                        const data = children[i].value
                            //console.log('inventory re value:', JSON.stringify(data))
                        this.nodes.push({
                            indent: indent,
                            url: '/edit-physical/' + data.id,
                            primary_text: a[a.length - 1],
                            secondary_text: (data.locationid !== undefined) ? 'location id: ' + data.locationid : undefined,
                            id: children[i].key,
                            highlight: perfect
                        });
                    }
                }
                tag.primaryHeader = 'Search inventory for ' + '\"' + q + '\"'
                tag.secondaryHeader = this.nodes.length + ' results'
                tag.update();

            }.bind(this));
        }.bind(this)

        this.on('mount', function() {
            updateInventoryTree()
        });

        this.submitForm = function(e) {
            e.preventDefault()
            q = encodeURIComponent(this.refs.searchinventory.value)
                //q = this.refs.searchinventory.value
            const iurl = '/inventory/' + q
            updateInventoryTree()
                //route(iurl)
                //route('/inventory/?q=' + encodeURIComponent(this.refs.searchinventory.value))
        }.bind(this)

    </script>
</parts-inventory-form>

<inventory-treeview2>

    <list-item each={node in opts.nodes} item={node} />
    <script>
        /*
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <list-header primary-header={primaryHeader} secondary-header={secondaryHeader}/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            */
        const tag = this;


        this.on('mount', function() {

        });

        this.on('updated', function() {
            console.log('inventory-treeview, opts:', JSON.stringify(opts))

        });

        /*
            this.primaryHeader = 'Lab inventory'
            const tag = this
            this.subitems = []

            app.observe('inventory', function(list) {
              this.secondaryHeader = ''
              this.searchresult = list

              var item = list
              var subitems = []
              for (var key in item) {
                if (item.hasOwnProperty(key)) {
                  var ditem = {
                    primary_text: key,
                    subitem: item[key]
                  }
                  subitems.push(ditem)
                }
              }
              this.subitems = subitems
              console.log('inventory-treeview :',JSON.stringify(subitems))
              tag.update()
            })

        */

    </script>

</inventory-treeview2>
