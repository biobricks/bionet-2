<home>
  <content-container style="padding-top:100px;">
    <section-container>
      <div id="home-page-content" class="{theme.style.color.background} {theme.style.color.text}">
        <mpassword-form/>
      </div>
      <div style="height:30px" />
      <div class="center red-text">{msg}</div><br/>
    </section-container>
  </content-container>
  <script>
    const tag = this
    self.msg = ''

    sudocms.observe('signupClient', function(step) {

      self.msg = step.msg
      tag.update()

      switch (step.name) {
        case 'email':
          if (!step.err) riot.mount('div#home-page-content', 'email-form')
          break;
        case 'password':
          if (!step.err) riot.mount('div#home-page-content', 'password-form')
          break;
        case 'complete':

          riot.route('inventory')
          sudocms.dispatch(sudocms.$.loginState, true)

          // clear signup session
          sudocms.dispatch('signupServer', {
            name: 'init'
          })
          self.msg = ''

          break;
      }
    })

  </script>
</home>

<!-- todo: if logged in, don't display join segment -->
<mpassword-form>
  <form class="col center">
    <img class="center" src="static/images/home-bionet.png" height="220px" />
    <div style="height:40px" />

    <search-input label="search biomaterials" name="searchbio" action={searchclick} value={searchbioInit}/>
    <!--
    <div class="input-field">
      <input id="search" type="search" required>
      <label for="search"><i class="material-icons black-text">search</i></label>
      <i class="material-icons">close</i>
    </div>
-->
    <div if={!loggedin}>
      <div class="center">OR</div>
      <form-text-input-empty label="enter invitation code, hint:'code'" name="mpassword" value={mpasswordInit}/>
      <std-button action={signupAction} label="sign up" />
    </div>
  </form>


  <script>
    const tag = this
    self.searchbioInit = ''
    self.mpasswordInit = ''

    self.loggedin = sudocms.getLoginState()
    var observer = {}

    const getParam = function(q, token) {
      var value = '';
      if (q.indexOf(token) >= 0) {
        var pos = q.indexOf(token)
        value = q.substr(pos + 2)
        pos = value.indexOf(' ')
        if (pos > 0) {
          value = value.substr(0, pos - 1)
        }
      } else {
        value = undefined
      }
      return value
    }

    // submit search query and route to search results
    self.searchclick = function() {
      var partid = self.searchbio.value
      var distance = getParam(partid, 'd:')
      var locationid = getParam(partid, 'l:')
      if (locationid === undefined) locationid = 'LAB'
      const pos = partid.indexOf(':')
      if (pos >= 0) {
        if (pos === 1) partid = undefined
        else partid = partid.substr(0, pos - 2)
      }
      const q={
        q:self.searchbio.value
      }
      /*
      const q = {
        q: self.searchbio.value,
        partid: partid,
        locationid: locationid,
        distance: distance
      }
      */
      sudocms.dispatch('bioClassQuery', q)
      console.log('search query:',JSON.stringify(q))
      sudocms.dispatch('bioClassCache', [])
      riot.route('q?terms='+encodeURIComponent(self.searchbio.value))
    }

    this.on('before-mount', function() {
      observer = sudocms.addObserver(sudocms.$.loginState, function(loginState) {
        self.loggedin = loginState
        tag.update()
      })
    })
    this.on('unmount', function() {
      sudocms.removeObserver(sudocms.$.loginState, observer)
    })

    self.signupAction = function(e) {
      sudocms.dispatch('signupServer', {
        name: 'mpassword',
        value: self.mpassword.value
      })
    }

  </script>
</mpassword-form>

<email-form>
  <form class="col s6 center">
    <img class="center" src="static/images/home-bionet.png" height="220px" />
    <div style="height:40px" />
    <form-text-input-empty label="enter email" name="enteremail" value={enteremailInit}/>
    <std-button action={submitForm} label="join" />
  </form>
  <script>
    self.enteremailInit = ''

    self.submitForm = function(e) {
      sudocms.dispatch('signupServer', {
        name: 'email',
        value: self.enteremail.value
      })
    }

  </script>
</email-form>

<password-form>
  <form class="col s6 center">
    <img class="center" src="static/images/home-bionet.png" height="220px" />
    <div style="height:40px" />
    <password-text-input-empty label="enter a password" name="enterpassword1" />
    <password-text-input-empty label="enter password again" name="enterpassword2" />
    <std-button action={submitForm} label="join" />
  </form>

  <script>
    self.submitForm = function(e) {
      // check if passwords match before proceeding
      if (self.enterpassword1.value !== self.enterpassword2.value) {
        sudocms.dispatch('signupClient', {
          name: 'password',
          err: true,
          msg: 'Passwords do not match.'
        })
        return
      }
      sudocms.dispatch('signupServer', {
        name: 'password',
        value: self.enterpassword1.value
      })
    }

  </script>
</password-form>
