<parts-inventory>
    <content-container style="padding-top:100px;">
        <section-container>
            <form onsubmit={this.submitForm}>
                <search-input label="search inventory" name="searchinventory" action={searchclick}/>
                <input type="submit" style="display:none" />
                <div id="part-inventory-content" class="{theme.style.color.background} {theme.style.color.text}">
                    <inventory-treeview nodes={this.nodes} />
                </div>
            </form>
        </section-container>
    </content-container>
    <script>
        const tag = this

        this.nodes = [];

        this.submitForm = function() {

            route('/inventory?q=' + encodeURIComponent(this.refs.searchinventory.value))
        }


        this.on('mount', function() {
            if (!this.opts.q) return;
            var q = decodeURIComponent(this.opts.q);
            this.refs.searchinventory.value = q;

            this.update();

            q = new RegExp(q.replace(/\s+/, '.*'), 'i');


            function itemFromNode(node) {

            }

            // TODO remove settimeout
            setTimeout(function() {

                app.remote.inventoryTree(function(err, children) {
                    if (err) return console.error(err);

                    // TODO rewrite this matching algorithm 
                    //      so we can do single-pass matching
                    //      so we can use a stream

                    var matches = [];
                    this.nodes = [];

                    var i, cur, indent, a;
                    for (i = 0; i < children.length; i++) {
                        cur = children[i].path;
                        if (cur.match(q)) matches.push(cur);
                    }

/*
        return {
          url: '/edit/' + x.id,
          secondary_url: '/q?partid=' + x.id,
          secondary_url_label: 'view availabilty',
          righticon: 'star',
          primary_text: x.id,
          secondary_text: x.description,
          starred: false,
          data: x.data
*/
                    var j, m, add, perfect;
                    for (i = 0; i < children.length; i++) {
                        cur = children[i].path;
                        a = cur.split('.');
                        indent = a.length - 1;
                        add = false
                        perfect = false
                        for (j = 0; j < matches.length; j++) {
                            m = matches[j];
                            if (m.indexOf(cur) === 0) {
                                add = true;
                                if (m.length === cur.length) perfect = true;
                                break;
                            }
                        }
                        if (add) {
                            this.nodes.push({
                                indent: indent,
                                url: 'edit-physical/'+children[i].path+"/?id="+children[i].key,
                                primary_text: a[a.length - 1],
                                id: children[i].key,
                                highlight: perfect
                            });
                        }
                    }

                    tag.update();

                });
            }, 500);
        })

    </script>
</parts-inventory>

<inventory-treeview>

    <list-container>
        <ul style="margin:0 0 0 1em;position:relative">
            <li style="padding:0 1.5em;">
                <list-item each={node in nodes} item={node} />
            </li>
        </ul>
    </list-container>

    <script>
        /*
            <list-header primary-header={primaryHeader} secondary-header={secondaryHeader}/>
            */
        const tag = this;


        this.on('mount', function() {

        });

        this.on('updated', function() {

        });

        /*
            this.primaryHeader = 'Lab inventory'
            const tag = this
            this.subitems = []

            app.observe('inventory', function(list) {
              this.secondaryHeader = ''
              this.searchresult = list

              var item = list
              var subitems = []
              for (var key in item) {
                if (item.hasOwnProperty(key)) {
                  var ditem = {
                    primary_text: key,
                    subitem: item[key]
                  }
                  subitems.push(ditem)
                }
              }
              this.subitems = subitems
              console.log('inventory-treeview :',JSON.stringify(subitems))
              tag.update()
            })

        */

    </script>

</inventory-treeview>
