<create-physical>

    <div class="container" style="margin-top:100px">
        <form id="createPhysicalForm" ref="createPhysicalForm" class="col s12" onsubmit={submitForm}>
            <div class="row">
                <h5 id="createPhysicalHeader" ref="createPhysicalHeader"></h5>
            </div>

            <input type="hidden" ref="id" name="id" value={formData.id} />
            <div class="row">
                <form-text-input label="Name" ref="name" name="name" value={formData.name}/>
            </div>

            <div class="row">
                <form-textarea-input label="Notes" ref="notes" name="notes" value={formData.notes}/>
            </div>

            <div each={field in fields}>
                <div class="row">
                    <form-text-input label={field.name} ref={ 'field_'+field.name} name={field.name} value="" />
                </div>
            </div>

            <div class="row">
                <form-text-input label="Barcode" ref="curBarcode" name="barcode" value={formData.barcode}/>
            </div>

            <div class="row">
                <a id="scanButton" class="waves-effect waves-light btn" onclick={scanItem} style="margin-right:10px">scan</a> or <a id="createLabelButton" class="waves-effect waves-light btn" onclick={createLabel} style="margin-left:10px">create label</a>
            </div>

            <div class="row">
                <form-text-input label="Container ID" ref="locationid" name="parent_id" value={formData.parent_id}/>
            </div>

            <div class="row">
                <a id="containerScanButton" class="waves-effect waves-light btn" onclick={scanContainer} style="margin-right:10px">scan container</a>
                <p>or</p>
                <div id="autocomplete-container" />
            </div>

            <input type="hidden" ref="virtual_id" name="virtual_id" value={formData.virtual_id} />
            <std-button label="submit" action={submitForm} />
            <input type="submit" style="visibility:hidden" />
        </form>

        <div id="scanModal" class="scanModal modal"></div>
        <div id="printModal" class="printModal modal"></div>
    </div>
    <script>
        console.log("create physical tag, opts:%s", JSON.stringify(opts))
        const appSettings = app.getAppSettings()
        const dataTypes = appSettings.dataTypes
        this.formData = {
            name: '',
            notes: ''
        }
        this.fields = []
            //console.log('create physical, object=',JSON.stringify())
        for (var i = 0; i < dataTypes.length; i++) {
            const dataType = dataTypes[i]
            if (opts.type === dataType.name && dataType.fields !== undefined) {
                const fields = dataType.fields
                Object.keys(fields).forEach(function(key, index) {
                    this.fields.push({
                        name: key,
                        value: fields[index]
                    })
                }.bind(this));
            }
        }

        var savePhysical = function(p, labelImage) {
            console.log("SAVING:", p);
            var doPrint = labelImage ? true : false
            app.remote.savePhysical(p, labelImage, doPrint, function(err, id) {
                if (err) {
                    app.ui.toast("Error: " + err); // TODO improve
                    if (cb) cb(err)
                    return;
                }

                app.ui.toast("Saved to database")
                setTimeout(function() {
                    route('edit-physical/' + encodeURIComponent(id) + '/');
                }, 500);
            })
        }.bind(this)

        /*
           TODO:
             associate with virtual
        */
        this.submitForm = function(e) {
            e.preventDefault()
            var formData = $.formToObject('createPhysicalForm') || {};
            formData.label = this.labelFormData;

            if (!formData.parent_id) {
                if (formData.parent_name) {
                    app.remote.getBy('name', formData.parent_name, function(err, m) {
                        if (err) return app.ui.toast("Error:" + err);

                        if (!m) {
                            app.ui.toast("Warning: Invalid container");
                        } else {
                            formData.parent_id = m.id;
                            this.update();
                        }
                        savePhysical(formData, this.labelImageData);
                    }.bind(this))
                    return;
                }
            }

            savePhysical(formData, this.labelImageData);
        }.bind(this)

        this.createLabel = function() {
            var tags = []
            var defaultLabelOpts = {
                title: this.printNameDefault,
                bsl: 1
            }
            var labelOpts = {
                title: "Create label",
                subtitle: undefined,
                subTag: "print", // the tag to mount
                label: this.labelFormData || defaultLabelOpts,
                cb: function(err, formData, imageData) {
                    this.labelFormData = formData;
                    this.labelImageData = imageData;
                    $(this.printModal).closeModal();
                    $(this.createLabelButton).html('edit label');
                }
            }
            tags = riot.mount('#printModal', 'modal-content', labelOpts)

            $(this.printModal).openModal({
                complete: function() {
                    tags[0].unmount(true)
                }
            })
        }.bind(this)

        this.scanItem = function() {
            console.log('scanItem')
            var tags = []
            var scanOpts = {
                title: "Scan",
                subtitle: "Scan the item's barcode",
                subTag: "scan", // the tag to mount
                cb: function(err, id) {
                    if (err) return app.ui.toast("Scan failed: " + err); // TODO handle error
                    $(this.curBarcode).val(id);
                    $(this.scanButton).html('rescan');
                    $(this.scanModal).closeModal();
                    console.log('scan item cb, tags:', tags)
                    tags[0].unmount(true)
                }
            }
            tags = riot.mount('#scanModal', 'modal-content', scanOpts)

            $(this.scanModal).openModal({
                complete: function() {
                    tags[0].unmount(true)
                }
            })
        }.bind(this)

        this.scanContainer = function() {
            console.log('scan container function')
            var tags = []
            var scanOpts = {
                title: "Scan location",
                subtitle: "Scan the barcode of e.g. the box or freezer where you put this item",
                subTag: "scan",
                cb: function(err, id) {
                    if (err) return app.ui.toast("Scan failed: " + err); // TODO handle error
                    app.ui.toast("Looking up scanned item");

                    app.remote.getBy('barcode', id, function(err, m) {
                        if (err) return app.ui.toast("Lookup failed. Item does not exist in database.");

                        $(this.curContainerBarcode).val(m.id);
                        $(this.containerScanButton).html('rescan container');
                    })

                    $(this.scanModal).closeModal();
                    tags[0].unmount(true)
                }
            }
            tags = riot.mount('#scanModal', 'modal-content', scanOpts)

            $('#scanModal').openModal({
                complete: function() {
                    tags[0].unmount(true)
                }
            })
        }.bind(this)

        this.on('mount', function() {

            if (!this.formData) {
                this.formData = {};
            }

            if (opts.query && opts.query.name && opts.query.name.trim()) {
                this.formData.name = decodeURIComponent(opts.query.name);
            }

            this.update();
            // todo: was opts.id but apparently riot uses opts.id for something else
            riot.mount('#autocomplete-container', 'autocomplete', {
                searchCallback: function(query, cb) {
                    app.remote.physicalAutocomplete(query, function(err, result) {
                        cb(err, result);
                    })
                },
                name: 'parent_name',
            });

            // if we are editing
            if (opts.physicalID) {
                app.remote.get(opts.physicalID, function(err, data) {
                    if (err) {
                        app.dispatch('error', err)
                        return
                    }
                    this.formData = data

                    this.printNameDefault = data.name;
                    $(this.refs.createPhysicalHeader).html("Edit")
                    this.update()
                }.bind(this))
                return;
            }


            if (opts.virtualID) {
                // create new physical instance of this material
                app.remote.get(opts.virtualID, function(err, virtual) {
                    if (err) {
                        app.ui.toast(err); // TODO handle better
                        return;
                    }
                    this.formData.virtual_id = virtual.id;
                    this.formData.name = virtual.name;
                    this.printNameDefault = this.refs.name.value.trim() || virtual.name
                    $(this.refs.createPhysicalHeader).html("New " + virtual.name)
                    this.update();
                    // TODO

                }.bind(this));
                return;
            }

            app.remote.getType(opts.type, function(err, type) {
                if (err) {
                    if (err.notFound) {
                        // we are creating a material of unknown type
                        route('/create-unknown/' + encodeURIComponent(opts.type))
                        return
                    }
                    return app.ui.toast(err); // TODO handle better
                }
                // We are creating a new material of type: opts.type

                if (type.virtual) {
                    // this type needs to be a virtual that then has physicals associated
                    route('/create/' + encodeURIComponent(opts.type));
                    return;
                }

                this.printNameDefault = this.refs.name.value.trim() || type.name
                $(this.refs.createPhysicalHeader).html("New " + type.name)

            }.bind(this));
        }.bind(this));

    </script>
</create-physical>


<modal-content>
    <div>
        <div class="modal-content">
            <h4>{opts.title}</h4>
            <p>{opts.subtitle}</p>
            <div id="modalContents"></div>
        </div>
        <!--
    <div class="modal-footer">
      <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">Agree</a>
    </div>
-->
    </div>

    <script>
        var tags;

        this.on('mount', function() {
            tags = riot.mount('#modalContents', opts.subTag, opts);
        })

        this.on('before-unmount', function() {
            tags[0].unmount()
        })

    </script>
</modal-content>
