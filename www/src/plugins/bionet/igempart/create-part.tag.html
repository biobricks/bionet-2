<create-part>
    <!--
    <div style="padding-top:165px;">
        <div id="create-part-content" class={themeClass}>
        </div>
    </div>
    -->
    
    <div class="content-height">
        create part<br/>
        <!--
        <div class="fixed-action-btn" style="bottom:100px; left:25px; width:50px; text-align:left">
            <a class="btn-floating btn-large waves-effect waves-light green dropdown-button"><i class="material-icons" data-activates="addmenu">add</i></a>
        </div>
        -->


        <div class="inventory-tree">
            <table id="ftree" style="margin-top:15px; width:400px;border:none !important;">
                <colgroup>
                    <col width="390px"></col>
                    <!--
                <col width="*"></col>
                <col width="250px"></col>
                <col width="150px"></col>
                <col width="100px"></col>
            -->
                </colgroup>
                <!--
                <thead>
                    <tr>
                        <th style="padding-left:10px">Name</th>
                    </tr>
                </thead>
                -->
                <tbody style="border: none !important;">
                    <tr>
                        <td></td>
                        <!--
                    <td></td>
                    <td></td>
                    <td></td>
                    -->
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="physical-storage" class="edit-physical">
        <div id="create-part-content" class={themeClass}>
        </div>
            <!--
            <create-physical show="false" top-margin="0px" />
            -->
        </div>
        <div id="scanner" style="position:absolute;top:100px; left:0px"></div>
    
        <a class="btn-floating btn-large waves-effect waves-light green dropdown-button" data-constrainwidth="false" data-hover="true" style="position:absolute; top:130px; right:25px; text-align:left" data-activates="addmenu"><i class="material-icons">add</i></a>
        <ul id="addmenu" class="dropdown-content" style="position:absolute; top:130px; right:25px; width:200px !important; text-align:left;z-index:1000">
            <li if={createType==='storage' } each={item in locations} class="add-type"><span onclick={addNode}>{item.name}</span></li>
            <li if={createType==='material' } each={item in materials} class="add-type"><span onclick={addNode}>{item.name}</span></li>
        </ul>
    
        <div class="fixed-action-btn" style="position:absolute; top:200px; right:25px; text-align:left">
            <a onclick={deleteNode} class="btn-floating btn-large waves-effect waves-light red"><i class="material-icons">delete</i></a>
        </div>
    
    </div>
    <style>
        table.fancytree-ext-table tr td {
            border: none !important;
            padding: 8px;
            display: table-cell;
        }
        
        .inventory-tree {
            overflow: auto;
            float: left;
            margin-left: 25px;
            width: 400px;
        }
        
        span.fancytree-edit {
            cursor: 'pointer';
        }
        
        li.add-type:hover {
            background-color: #E5F3FB;
            outline: 1px solid #70C0E7;
        }
        
        .edit-physical {
            overflow: auto;
            width: calc(100% - 600px);
            float: left;
            //margin-left: 25px;
        }
        
        div.content-height {
            margin-top: 115px;
            height: calc(100% - 100px)
        }

    </style>
    <script>
        const theme = app.getTheme()
        this.themeClass = theme.style.color.background + ' ' + theme.style.color.text

        // setup secondary nav
        app.dispatch(app.$.secondaryNav, [{
            label: 'virtual properties',
            icon: undefined,
            action: '/create-virtual/' + this.opts.type
        }, {
            label: 'physical properties',
            icon: undefined,
            action: '/create-virtual/' + this.opts.type + '/?tab=instances'
        }, {
            label: 'attachments',
            icon: undefined,
            action: '/create-virtual/' + this.opts.type + '/?tab=attachments'
        }])

        // initialize breadcrumbs
        app.dispatch(app.$.breadcrumbs, [{
            'label': 'inventory',
            'url': '/'
        }, {
            'label': 'create part',
            'url': '#'
        }]);

        // configure app bar
        app.dispatch(app.$.appBarConfig, {
            enableTopNav: true,
            enableBreadCrumbs: true,
            enableSubbar: true
        })

        this.on('mount', function() {
            const tab = opts.query.tab
            if (tab === 'attachments') {
                riot.mount('div#create-part-content', 'part-attachment')
            } else if (tab === 'instances') {
                riot.mount('div#create-part-content', 'create-instances')
            } else {
                riot.mount('div#create-part-content', 'create-virtual-form', opts)
            }
        })

    </script>
</create-part>

<create-virtual-form>
    <h5 id="createVirtualHeader" ref="createVirtualHeader">Create {type}</h5>
    <form id="createPartForm" ref="createPartForm" class="col s12" onsubmit={submitForm}>
        <form-text-input label="Name" ref="name" name="name" value={formData.name}/>
        <form-textarea-input label="Description" ref="description" name="description" value={formData.description}/>
        <form-text-input label="Created by" ref="creator" name="creator.user" value={formData.creator.user}/>
        <form-text-input label="Created" ref="created" name="creator.time" value={formData.creator.time}/>
        <form-textarea-input label="Biosafety level" ref="bsl" name="bsl" value={formData.bsl}/>
        <form-switch label="Biohazardous?" ref="biohazard" name="biohazard" value={formData.biohazard} options={[ 'No', 'Yes']}/>
        <div each={field in fields}>
            <form-text-input label={field.name} ref={ 'field_'+field.name} name={field.name} value="" />
        </div>
        <form-textarea-input label="Notes" name="notes" value={formData.notes}/>
        <std-button label="submit" action={submitForm} />
        <input type="submit" style="visibility:hidden" />
    </form>
    <script>
        const tag = this
        this.type=decodeURIComponent(opts.type)
        console.log('create-virtual-form, opts:%s', JSON.stringify(this.opts))
            /*
        <form-textarea-input label="Sequence" ref="sequence" name="sequence" value={formData.sequence}/>
                creator: app.user.email,
                created: new Date().toDateString(),
            */

        this.fields = app.getAttributesForType(this.type)

        app.state.createPart = app.state.createPart || {}
        this.formData = {
            type: this.type,
            name: '',
            description: '',
            creator: {
                user: app.user.email,
                time: new Date().toDateString()
            },
            notes: '',
            bsl: '',
            biohazard: ''
        }
        for (var i=0; i<this.fields.length; i++) {
            this.formData[this.fields[i].name]=''
        }
        $.extend(app.state.createPart, this.formData)

        console.log('create-virtual-form, createPart:%s', JSON.stringify(app.state.createPart))

        this.on('mount', function() {

            if (tag.opts.query && tag.opts.query.name && tag.opts.query.name.trim()) {
                tag.formData.name = decodeURIComponent(tag.opts.query.name);
                tag.update();
                $.extend(app.state.createPart, $.formToObject('createPartForm'))
            }
            console.log('create-virtual-form, formData:%s', JSON.stringify(tag.formData))

            $(tag.refs.createPartForm).change(function(e) {
                $.extend(app.state.createPart, $.formToObject('createPartForm'))
            });

        });

        // TODO JUUl this doesn't work if using $(this.createPartForm)
        // probably because it needs to be run from within on('mount')

        this.submitForm = function(e) {
            e.preventDefault()

            app.remote.saveVirtual(app.state.createPart, function(err, id) {
                if (err) return app.ui.toast("Error: " + err) // TODO handle error

                app.ui.toast("Virtual created with ID: " + id)
                app.state.editPart = app.state.createPart
                route('/edit/' + id);
            });

        }.bind(this)

    </script>
</create-virtual-form>


<create-sequence>
    <form class="col s12" onsubmit={submitForm}>
        <form-textarea-input label="DNA Sequence" name="sequence" value={formData.sequence}/>
        <std-button action={submitForm} label="submit" />
        <input type="submit" style="visibility:hidden" />
    </form>
    <script>
        app.state.createPart = app.state.createPart || {}
        this.formData = {
            sequence: ''
        }
        this.submitForm = function(e) {
            e.preventDefault()
            console.log("SUBMIT sequence form");
        }

    </script>
</create-sequence>

<create-instances>
    <form onsubmit={submitForm}>
        <form-text-input label="Physical Location Code" ref="location" name="location" value={formData.location}/>
        <form-text-input label="Datamatrix Code" ref="datamatrix" name="datamatrix" value={formData.qrcode}/>
        <form-image imagesrc={formData.qrcode} label="Datamatrix code" height="140px" />
        <std-button action={submitForm3} label="submit" />
        <input type="submit" style="visibility:hidden" />
    </form>
    <script>
        this.formData = {
            location: '',
            qrcode: ''
        }
        this.submitForm = function() {
            e.preventDefault()
            console.log("SUBMIT instance form");
        }

    </script>
</create-instances>
