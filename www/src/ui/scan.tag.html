<scan>

  <div class="scan">
    <div class="error"></div>

    <div id="cameraAccessMsg">
      <h5 style="color:green">Waiting for browser camera access</h5>
      <p>Without camera access you will only be able to scan using an attached USB barcode scanner</p>
    </div>

    <canvas id="scanCanvas" class="scanCanvas" width="560" height="560"></canvas>
    <video id="scanVideo" class="scanVideo" width="440" height="330"></video>
    <div id="debug"></div>
    <div class="canvas-layers"></div>
    <div class="canvas-box"></div>
    <form class="keyboard-form" ref="keyboardInputForm" onsubmit={keyboardScan}>
      <input id="keyboardInput" type="text" ref="code" autocomplete="off" />
      <input type="submit" />
    </form>
  </div>
  <script>

    var cameraStream;
    var modalCallback;

    var keepScanning = true;
    var enableDM = false;

    var QrCode = require('qrcode-reader');
    var getUserMedia = require('getusermedia');
    var path = require('path');
    var settings = require('../../../settings.js')

    var dmdecode = require("datamatrix-decode");
//    var datamatrix = require('../../../../biomatrix-scratch');
    
    function getIDFromURL(url) {
      var m = url.match(new RegExp('^'+settings.base_url+'/p/(\\d+)'));
      if(!m || (m.length < 2)) return null;
      return parseInt(m[1]);
    }

    function decodeQrCode(cb) {
      var data = this.scanCtx.getImageData(0, 0, this.scanCanvas.width, this.scanCanvas.height);
      this.qr.callback = cb;
      this.qr.decode(data);
    }

    function decodeDMCode(cb) {
      datamatrix(null, this.scanCanvas, {
        debug: true
      }, function(err, data) {
        $('.canvas-layers').html(' '); // TODO tmp debug removal
        $('.canvas-box').html(' '); // TODO tmp debug removal
        if(err) return cb(null)
        cb(data);
      });
    }

    function debug(str) {
      str = $('#debug').html() + "<br/>\n" + str;
      $('#debug').html(str);
    }

    function scanSuccess(code) {
       runCallback(null, code)
    }

    function scan(delay) {
      if(!keepScanning) return;
      delay = delay || 500; // delay between frames in ms

      this.scanCtx.drawImage(this.scanVideo, 0, 0);
      console.log("scanning...")
      decodeQrCode(function(data) {
        if(!data) {
                           console.log("did not get data");
          if(!enableDM) {
            setTimeout(scan, delay);
          } else {
            decodeDMCode(function(data) {
              if(!data) return setTimeout(scan, delay);
              console.log("GOT CODE");
              // TODO decode then call scanSuccess
            });
          }
          return
        }
                           console.log("GOT DATA:", data);
        var id = getIDFromURL(data);
        if(!id) return setTimeout(scan, delay);
        // TODO visual indication of scan success
        scanSuccess(id);
      });
    }

    function scanError(str) {
      $('.scan .error').html(str);
      $('#scanVideo').css('display', 'none');
    }

    this.on('unmount', function() {
      keepScanning = false;
    })

    this.keyboardScan = function(e) {
      e.preventDefault();
      var code = this.keyboardInputForm.code.refs.value;
      code = code.replace(/[^\d]+/g, '');
      if(code.length <= 0) {
        $('#keyboardInput').val('');
        app.ui.toast("Invalid scan..."); // TODO better errer handling
        return;                       
      }
      scanSuccess(code);
    }.bind(this);

    // prevent text input field from loosing focus
    function initKeyboardCapture() {

      setTimeout(function() {
        $('#keyboardInput').focus()
        $(this.keyboardInputForm.code).blur(function(e) {
          $('#keyboardInput').focus()
        });
      }, 1)
    }

    function stopCameraStream() {
      if(cameraStream) {
        var tracks = cameraStream.getTracks();
        var i;
        for(i=0; i < tracks.length; i++) {
          tracks[i].stop();
        }
        cameraStream = null
      }
    }

    function runCallback(err, code) {
      stopCameraStream();
      if(modalCallback) return modalCallback(err, code);

      window.location.href = '/p/' + code;
    }

    this.on('before-unmount', function() {
      stopCameraStream();
    });

    this.on('mount', function() {
      modalCallback = this.opts.cb
      this.qr = new QrCode();
      this.scanCtx = this.scanCanvas.getContext("2d");

      initKeyboardCapture()

      getUserMedia({video: true, audio: false}, function(err, stream) {
        $('#cameraAccessMsg').css('display', 'none');
        if(err) {
          if(err.name === 'DevicesNotFoundError' || err.name === 'NotFoundError') {
            scanError("Hmm, looks like your device doesn't have a camera.<br/>You can still use the hand-held USB scanner.");
          } else if(err.name === 'InternalError') {
            scanError("Could not access your camera. Is another application using it?");
          } else {
            scanError("Unknown camera access error: " + err.msg)
          }
          return;
        }
        cameraStream = stream

        $(this.scanVideo).css('visibility', 'visible');
        this.scanVideo.src = window.URL.createObjectURL(stream);
        this.scanVideo.play();

        setTimeout(scan, 500);
      });
    });
  </script>
</scan>
