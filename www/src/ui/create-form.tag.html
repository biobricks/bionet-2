<create-form>
  
  <content-container style="padding-top:100px;">

    <form name="createForm">
      <div>What would you like to add?</div>
      <div>
        <div id="selectedTypeContainer" class="selected-type">
          <span id="selectedTypeLabel">plasmid</span>
        </div>
        <div class="query-container">
          <input type="text" name="q" placeholder="enter partial or complete name" autocomplete="off" autofocus onblur={hideMatches} />
        </div>
      </div>
      <div class="sub-hint">Examples: plasmid, strain, ethanol</div>
      <ul id="matchList">
        <li each={match, index in matches} class="{highlight: selected === index} {match.extraClass || ''}" onmouseover={elementOver}>{!selectedType ? match.pre : ''}{(match.pre && !selectedType) ? ': ' : ''}{match.name}</li>
        <li if={matches && !matches.length} class="no-match">No matches found - Hit enter to create{selectedType ? ' new ' + selectedType : ''}</li>
      </ul>
    </form>
  </content-container>
  <script>

    
   function query(type, s) {
    s = s.trim();
    if(!s) return null;
    s = s.replace(/\s+/g, ' ')
    s = new RegExp(s, 'i')
    var a =  [
      { pre: "type", name: "plasmid", extraClass: 'type'},
      { pre: "type", name: "-80 freezer", extraClass: 'type'},
      { pre: "type", name: "dna", extraClass: 'type last-type'},
      { pre: "plasmid", name: "p1204"},
      { pre: "plasmid", name: "p1208"}
        ]
    var ret = [];
    var i;
    for(i=0; i < a.length; i++) {
      if(a[i].name.match(s)) {
        if(type && a[i].pre !== type) continue;
        ret.push(a[i]);
      }
    }
    return ret;
   }

    self.selected = null
    self.selectedType = null

    this.on('mount', function() {
      self.updateMatchListPosition = function() {
        var pos = $(self.createForm.q).offset();
        pos.top += $(self.createForm.q).innerHeight() + 2;
        pos.width = $(self.createForm.q).innerWidth();
        $(self.matchList).css(pos)
      }.bind(this)

      self.selectCurrent = function() {
        var sel = self.matches[self.selected]
        if(sel.pre === 'type') {
          self.setSelectedType(sel.name)
          self.createForm.q.value = ''
        } else {
          self.createForm.q.value = sel.name
        }
        self.hideMatches()
      }.bind(this)

      self.setSelectedType = function(type) {
        if(!type) {
          self.selectedType = null
          $(self.selectedTypeContainer).css('display', 'none')
        } else {
          self.selectedType = type
          self.selectedTypeLabel.innerHTML = type
          $(self.selectedTypeContainer).css('display', 'block')
        }
        self.updateMatchListPosition()
      }.bind(this)

      self.hideMatches = function(e) {
        self.matches = null
        self.selected = null
        this.update()
      }.bind(this)

      self.elementOver = function(e) {
        if($(e.target).hasClass('no-match')) return;
          var lis = $(self.matchList).find('li');
        var i;
        for(i=0; i < lis.length; i++) {
          if(lis[i] == e.target) {
            self.selected = i
            break
          }
        }
        this.update()

     }.bind(this)

      self.updateMatchListPosition();

      self.matches = []

      var hadQueryBeforeKeydown = false;
      $(self.createForm.q).keydown(function(e) {
        if(e.keyCode === 38) { // up arrow
          e.preventDefault()
          if(self.selected !== null && self.selected > 0) self.selected--
          this.update();
        } else if(e.keyCode === 40) { // down arrow
          e.preventDefault()
          if(self.selected !== null && self.selected < self.matches.length-1) self.selected++
          this.update();
        } else if(e.keyCode === 27) { // escape
          self.hideMatches()
        } else if(e.keyCode === 9) { // tab
          if(self.selected === null) return // normal operation if nothing selected
          e.preventDefault();
          self.selectCurrent()                                   
        } else {
          hadQueryBeforeKeydown = !!self.createForm.q.value.replace(/\s+/g, '')
        }

      }.bind(this));

      $(self.createForm.q).keyup(function(e) {
        if(e.keyCode === 8 || e.keyCode === 46) { // backspace or delete
          var hasQueryNow = !!self.createForm.q.value.replace(/\s+/g, '')
          console.log('UUUUUUU', e.keyCode, hadQueryBeforeKeydown, hasQueryNow)
          if(!hadQueryBeforeKeydown && !hasQueryNow) {
            self.setSelectedType()
          }
        }
      }.bind(this));

      $(self.createForm.q).on('input', function(e) {
        
        self.matches = query(self.selectedType, self.createForm.q.value);

        if(self.matches && self.matches.length) {
          selected = 0;
        } else {
          selected = null
        }
        this.update()
       

      }.bind(this))
    })

    this.on('updated', function() {
      if(self.matches && self.matches.length) {
        $(self.matchList).css('border', '')
      } else {
        $(self.matchList).css('border', 'none')
      }
      var q = self.createForm.q.value
      q = q.trim();
      q = q.replace(/\s+/g, ' ').toLowerCase()

      $(self.createForm.q).css('color', '');

      if(self.matches) {

        $(self.matchList).find('li').mouseover(function(e) {

        }.bind(this))

        // check for single exact match
        if(self.matches.length === 1) {
          if(self.matches[0].name.replace(/[^\w\d]+/g, '').toLowerCase() === q.replace(/[^\w\d]+/g, '')) {
            $(self.createForm.q).css('color', 'green')
          }
        }
      }
    })

    

  </script>
</create-form>
